var TXTools=function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";function n(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function o(){for(var t="",e=1;e<=32;e++){t+=Math.floor(16*Math.random()).toString(16),8!=e&&12!=e&&16!=e&&20!=e||(t+="-")}return t}function r(t){return document.getElementById(t)}function s(t,e,i,n){var o=Math.abs(t-i),r=Math.abs(e-n),s=Math.sqrt(o*o+r*r),a=Math.round(Math.asin(r/s)/Math.PI*180);return i>=t?n>=e?a:-a:n>=e?180-a:180+a}function a(t,e){var i=t.length;if(0==i)return-1;for(var n=0;n<i;n++)if(t[n]==e)return n;return-1}Object.defineProperty(e,"__esModule",{value:!0});setTimeout;var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);function h(t){var e,i,n,o,r,s;for(n=t.length,i=0,e="";i<n;){if(o=255&t.charCodeAt(i++),i==n){e+=d.charAt(o>>2),e+=d.charAt((3&o)<<4),e+="==";break}if(r=t.charCodeAt(i++),i==n){e+=d.charAt(o>>2),e+=d.charAt((3&o)<<4|(240&r)>>4),e+=d.charAt((15&r)<<2),e+="=";break}s=t.charCodeAt(i++),e+=d.charAt(o>>2),e+=d.charAt((3&o)<<4|(240&r)>>4),e+=d.charAt((15&r)<<2|(192&s)>>6),e+=d.charAt(63&s)}return e}function c(t){if(null==t||void 0===t||""==t)return"";var e,i,n,o,r,s,a;for(s=t.length,r=0,a="";r<s;){do{e=l[255&t.charCodeAt(r++)]}while(r<s&&-1==e);if(-1==e)break;do{i=l[255&t.charCodeAt(r++)]}while(r<s&&-1==i);if(-1==i)break;a+=String.fromCharCode(e<<2|(48&i)>>4);do{if(61==(n=255&t.charCodeAt(r++)))return a;n=l[n]}while(r<s&&-1==n);if(-1==n)break;a+=String.fromCharCode((15&i)<<4|(60&n)>>2);do{if(61==(o=255&t.charCodeAt(r++)))return a;o=l[o]}while(r<s&&-1==o);if(-1==o)break;a+=String.fromCharCode((3&n)<<6|o)}return a}function u(t){var e,i,n,o;for(e="",n=t.length,i=0;i<n;i++)(o=t.charCodeAt(i))>=1&&o<=127?e+=t.charAt(i):o>2047?(e+=String.fromCharCode(224|o>>12&15),e+=String.fromCharCode(128|o>>6&63),e+=String.fromCharCode(128|o>>0&63)):(e+=String.fromCharCode(192|o>>6&31),e+=String.fromCharCode(128|o>>0&63));return e}function p(t){var e,i,n,o,r,s;for(e="",n=t.length,i=0;i<n;)switch((o=t.charCodeAt(i++))>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e+=t.charAt(i-1);break;case 12:case 13:r=t.charCodeAt(i++),e+=String.fromCharCode((31&o)<<6|63&r);break;case 14:r=t.charCodeAt(i++),s=t.charCodeAt(i++),e+=String.fromCharCode((15&o)<<12|(63&r)<<6|(63&s)<<0)}return e}function g(){this.container={},this.set=function(t,e){try{return null!=t&&""!=t&&(this.container[t]=e),!0}catch(t){return!1}},this.get=function(t){try{return this.container[t]}catch(t){return null}},this.containsKey=function(t){try{for(var e in this.container)if(e==t)return!0;return!1}catch(t){return!1}},this.containsValue=function(t){try{for(var e in this.container)if(this.container[e]===t)return!0;return!1}catch(t){return!1}},this.remove=function(t){try{return delete this.container[t],!0}catch(t){return!1}},this.clear=function(){try{return delete this.container,this.container={},!0}catch(t){return!1}},this.isEmpty=function(){return 0==this.keySet().length},this.size=function(){return this.keySet().length},this.keySet=function(){var t=new Array;for(var e in this.container)t.push(e);return t},this.values=function(){for(var t=new Array,e=this.keySet(),i=0;i<e.length;i++)t.push(this.container[e[i]]);return t},this.entrySet=function(){for(var t=new Array,e=this.keySet(),i=0;i<e.length;i++)t.push(e[i],this.container[e[i]]);return t},this.sumValues=function(){for(var t=this.values(),e=0,i=0;i<t.length;i++)e+=Number(t[i]);return e}}function f(){this.HistoryGroup=new g,this.PointGroup=new g,this.RedoPointGroup=new g,this.RedoHistoryGroup=new g,this.Clear=function(t){this.HistoryGroup.remove(t),this.PointGroup.remove(t),this.RedoPointGroup.remove(t)},this.ClearRedo=function(t){this.RedoPointGroup.remove(t)},this.AddHistory=function(t,e){var i=this.HistoryGroup.get(t);if(null==i){var n=new Array;n.push(e),this.HistoryGroup.set(t,n)}else i.push(e),this.HistoryGroup.set(t,i)},this.Undo=function(t){var e=this.HistoryGroup.get(t);if(null==e)return null;var i=e.pop();return this.HistoryGroup.set(t,e),i},this.AddPoints=function(t,e){var i=this.PointGroup.get(t);if(null==i){var n=new Array;n.push(e),this.PointGroup.set(t,n)}else i.push(e),this.PointGroup.set(t,i)},this.UndoPoints=function(t){var e=this.PointGroup.get(t);if(null==e)return null;var i=e.pop();return this.PointGroup.set(t,e),i},this.AddRedoPoints=function(t,e){var i=this.RedoPointGroup.get(t);if(null==i){var n=new Array;n.push(e),this.RedoPointGroup.set(t,n)}else i.push(e),this.RedoPointGroup.set(t,i)},this.RedoPoints=function(t){var e=this.RedoPointGroup.get(t);if(null==e)return null;var i=e.pop();return this.RedoPointGroup.set(t,e),i},this.AddRedoHistory=function(t,e){var i=this.RedoHistoryGroup.get(t);if(null==i){var n=new Array;n.push(e),this.RedoHistoryGroup.set(t,n)}else i.push(e),this.RedoHistoryGroup.set(t,i)},this.RedoHistory=function(t){var e=this.RedoHistoryGroup.get(t);if(null==e)return null;var i=e.pop();return this.RedoHistoryGroup.set(t,e),i}}function v(t,e){this.name=t,this.data=e,this.target=null,this.container=null,this.main=null,this.pagenumber=0,this.canEdit=!0,this.EVENTSTART="mousedown",this.EVENTMOVE="mousemove",this.EVENTEND="mouseup",this.EVENTCLICK="click",this.ImagePath="/static/images/",this.deviceType=0,this.SetParamter=function(t,e,i,n,o){this.target=t,this.container=e,this.main=i,this.pagenumber=n,this.deviceType=o,0!=this.deviceType&&(this.EVENTSTART="touchstart",this.EVENTMOVE="touchmove",this.EVENTEND="touchend",this.EVENTCLICK="click",this.EVENTRESIZE="ontouchstart",this.ImagePath="img/")},this.SetCanEdit=function(t){this.canEdit=t},this.Play=function(){console.log(this.name+":Play not done")},this.getContainerWidth=function(){return this.container.width()},this.getContainerHeight=function(){return this.container.height()},this.getViewHeight=function(){return this.main.height()},this.getViewWidth=function(){return this.main.width()},this.GetFixedPageNumber=function(t){return(t+"").replace(".","\\.")},this.FixPoz=function(t,e,i){return parseFloat((t*i/e).toFixed(1))},this.FixLinePoz=function(t,e,i,n,o){for(var r=t.split(" "),s=-1,a=0,d=0,l="",h=0,c=r.length;h<c;h++)""!=Trim(r[h])&&(s=r[h].indexOf(","),a=parseInt(r[h].substr(1,s)),d=parseInt(r[h].substring(s+1)),l+=r[h][0]+this.FixPoz(a,e,n)+","+this.FixPoz(d,e,n),h<c-1&&(l+=" "));return l},this.FixLinePozEx=function(t,e,i,n,o){for(var r,s=/\d+\.?\d*/gi,a=0,d=0,l="";null!=(r=s.exec(t));){var h=parseFloat(r[0]),c=0;c=this.FixPoz(h,e,n),l+=0==a?t.substr(0,r.index)+c:t.substring(d,r.index)+c,d=r.index+r[0].length,a++}return a>=1&&(l+=t.substr(d)),l},this.Append=function(t,e){if(this.target=e||this.target,this.target[0].firstChild){var i=this.target.find(">path");0==i.length?this.target[0].insertBefore(t,this.target[0].firstChild):i.last().after($(t))}else this.target[0].appendChild(t)},this.CreateEle=function(t,e){var i=n(t);if(e)for(var o in e)i.setAttribute(o,e[o]);return i},this.ShowArrow=function(t){var e,i,n,o,r=$("#g_"+t.attr("id")),a=r.find(">line"),d=r.find(">rect"),l=$(r).find("path"),h=parseInt(t.attr("x")),c=parseInt(t.attr("y")),u=parseInt(t.attr("width")),p=parseInt(t.attr("height")),g=parseInt(d.attr("x")),f=parseInt(d.attr("y")),v=parseInt(d.attr("width")),b=parseInt(d.attr("height"));c>f+b?(e=h+u/2,i=c,n=g+v/2,o=f+b):f>c+p?(e=h+u/2,i=c+p,n=g+v/2,o=f):g+v/2>h+u/2?h>g?(e=h,i=c+p/2,n=g,o=f+b/2):(e=h+u,i=c+p/2,n=g,o=f+b/2):h>g+v?(e=h,i=c+p/2,n=g+v,o=f+b/2):(e=h+u,i=c+p/2,n=g+v,o=f+b/2),a.attr("x1",e),a.attr("y1",i),a.attr("x2",n),a.attr("y2",o),l.attr("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",n,o,n+10,o+5,n+10,o-5)),l.attr("transform",String.format("rotate({0},{1},{2})",s(n,o,e,i),n,o)),l.css("z-index","103")},this.SplitText=function(t,e){new Array;return function(t){for(var e=new Array;t.indexOf("\r\n")>-1||t.indexOf("\n")>-1;)t.indexOf("\r\n")>-1?(e.push(t.substring(0,t.indexOf("\r\n")+1)),t=t.substr(t.indexOf("\r\n")+1)):t.indexOf("\n")>-1&&(e.push(t.substring(0,t.indexOf("\n")+1)),t=t.substr(t.indexOf("\n")+1));return""!=t&&e.push(t),e}(t)}}function b(t){v.call(this,"PlayPen",t);var e=t;this.Play=function(){if(r(e.id))e.d.indexOf("C")>-1?r(e.id).setAttribute("d",this.FixLinePozEx(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())):r(e.id).setAttribute("d",this.FixLinePoz(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight()));else{var t=n("path");t.setAttribute("tp","line"),t.setAttribute("isdraw","true"),t.setAttribute("id",e.id),e.w?t.setAttribute("stroke-width",this.FixPoz(e.w,e.CW,this.getContainerWidth())):t.setAttribute("stroke-width",1),e.d.indexOf("C")>-1?t.setAttribute("d",this.FixLinePozEx(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())):t.setAttribute("d",this.FixLinePoz(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())),e.color?t.setAttribute("stroke",e.color):t.setAttribute("stroke","red"),e.op&&t.setAttribute("stroke-opacity",e.op),t.setAttribute("style","fill:white;fill-opacity:0;stroke-linecap:round;"),e.tar&&""!=e.tar&&"main"!=e.tar&&"body"!=e.tar&&"app"!=e.tar?$("#"+e.tar).find(">svg")[0]&&this.Append(t,$("#"+e.tar).find(">svg")):this.target&&this.Append(t)}}}function x(t){v.call(this,"PlayLine",t);var e=t;this.Play=function(){if(r(e.id))e.d.indexOf("C")>-1?r(e.id).setAttribute("d",this.FixLinePozEx(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())):r(e.id).setAttribute("d",this.FixLinePoz(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight()));else{var t=this.CreateEle("path",{tp:"line",isdraw:"true",id:e.id});e.w?t.setAttribute("stroke-width",this.FixPoz(e.w,e.CW,this.getContainerWidth())):t.setAttribute("stroke-width",1),e.d.indexOf("C")>-1?t.setAttribute("d",this.FixLinePozEx(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())):t.setAttribute("d",this.FixLinePoz(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())),e.color?t.setAttribute("stroke",e.color):t.setAttribute("stroke","red"),e.op&&t.setAttribute("stroke-opacity",e.op),t.setAttribute("style","fill:white;fill-opacity:0;stroke-linecap:round;"),e.tar&&""!=e.tar&&"main"!=e.tar&&"body"!=e.tar&&"app"!=e.tar?$("#"+e.tar).find(">svg")[0]&&this.Append(t,$("#"+e.tar).find(">svg")[0]):this.target&&this.Append(t)}}}function y(t){v.call(this,"PlayBrush",t),this.Play=function(){var e=t;if(r(e.id))r(e.id).setAttribute("d",this.FixLinePoz(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight()));else{var i=this.CreateEle("path",{tp:"brush",isdraw:"true",id:e.id});i.setAttribute("d",this.FixLinePoz(e.d,e.CW,e.CH,this.getContainerWidth(),this.getContainerHeight())),i.setAttribute("style","fill-opacity:0;stroke-opacity:0.5;stroke-linecap:round;"),e.w?i.setAttribute("stroke-width",this.FixPoz(e.w,e.CW,this.getContainerWidth())):i.setAttribute("stroke-width",30),e.color?i.setAttribute("stroke",e.color):i.setAttribute("stroke","yellow"),this.Append(i)}}}function w(t){v.call(this,"PlayText",t);var e=t,i=null;this.SetOnEdit=function(t){i=t},this.Play=function(){var t=this,n=function(){var i=t.CreateEle("g",{id:"g_"+e.id,isdraw:"true"});t.Append(i);var n=t.FixPoz(e.x,e.CW,t.getContainerWidth()),o=t.FixPoz(e.y,e.CW,t.getContainerWidth()),s=t.CreateEle("text",{x:n+1,y:o+1,style:"fill:red;font-size:14px;font-family: 'Consolas';"});s.innerHTML="",i.appendChild(s),""!=e.Rect.text&&r(e.id).setAttribute("style","fill:blue;stroke:blue;stroke-width:0;fill-opacity:0;");for(var a=t.SplitText(p(c(e.Rect.text)),t.FixPoz(e.width,e.CW,t.getContainerWidth())),d=0;d<a.length;d++){var l=t.CreateEle("tspan",{x:n+1,y:o+1+20*d});l.innerHTML=a[d],s.append(l)}};if(r(e.id)){if((u=r(e.id)).setAttribute("style","fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;"),u.setAttribute("x",this.FixPoz(e.x,e.CW,this.getContainerWidth())),u.setAttribute("y",this.FixPoz(e.y,e.CW,this.getContainerWidth())),u.setAttribute("width",this.FixPoz(e.width,e.CW,this.getContainerWidth())),u.setAttribute("height",this.FixPoz(e.height,e.CW,this.getContainerWidth())),e.Rect){if(!r("g_"+e.id))return void n();var o=this.FixPoz(e.x,e.CW,this.getContainerWidth()),s=this.FixPoz(e.y,e.CW,this.getContainerWidth()),a=$("#g_"+e.id).find(">text")[0];a.setAttribute("x",o+1),a.setAttribute("y",s+1),a.innerHTML="",""!=e.Rect.text&&r(e.id).setAttribute("style","fill:blue;stroke:blue;stroke-width:0;fill-opacity:0;");for(var d=this.SplitText(p(c(e.Rect.text)),this.FixPoz(e.width,e.CW,this.getContainerWidth())),l=0;l<d.length;l++){var h=this.CreateEle("tspan",{x:o+1,y:s+1+20*l});h.innerHTML=d[l],a.append(h)}}}else{var u;(u=this.CreateEle("rect",{id:e.id,isdraw:"true",tp:"text",style:"fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;"})).setAttribute("x",this.FixPoz(e.x,e.CW,this.getContainerWidth())),u.setAttribute("y",this.FixPoz(e.y,e.CW,this.getContainerWidth())),u.setAttribute("width",this.FixPoz(e.width,e.CW,this.getContainerWidth())),u.setAttribute("height",this.FixPoz(e.height,e.CW,this.getContainerWidth())),this.Append(u),e.Rect&&n();var g=$("#"+e.id);$("#"+e.id+",#g_"+e.id).bind(this.EVENTCLICK,function(t){i&&i(g,!1)})}}}function C(t){v.call(this,"PlayNote",t);var e=t,i=null;this.SetOnEdit=function(t){i=t};var n=null;this.SetOnRecord=function(t){n=t},this.Play=function(){var t,o=this,a=function(){var t=o.CreateEle("g",{id:"g_"+e.id,isdraw:"true",tp:"note"});o.Append(t);var i=o.FixPoz(e.Rect.x,e.CW,o.getContainerWidth()),n=o.FixPoz(e.Rect.y,e.CW,o.getContainerWidth()),r=o.CreateEle("rect",{style:"fill:white;stroke:blue;stroke-width:1;fill-opacity:0.3;",x:i,y:n});r.setAttribute("width",o.FixPoz(e.Rect.width,e.CW,o.getContainerWidth())),r.setAttribute("height",o.FixPoz(e.Rect.height,e.CW,o.getContainerWidth())),t.appendChild(r);var a=o.CreateEle("text",{x:i+5,y:n+15,style:"fill:rgb(0,0,0);font-size:14px;font-family: 'Consolas';"});a.innerHTML="",t.appendChild(a);for(var d=o.SplitText(p(c(e.Rect.text)),o.FixPoz(e.Rect.width,e.CW,o.getContainerWidth())),l=0;l<d.length;l++){var h=o.CreateEle("tspan",{x:i+5,y:n+15+20*l});h.innerHTML=d[l],a.append(h)}var u=o.CreateEle("line",{style:"stroke-width:1; stroke:blue;"});u.setAttribute("x1",o.FixPoz(e.Rect.x1,e.CW,o.getContainerWidth())),u.setAttribute("y1",o.FixPoz(e.Rect.y1,e.CW,o.getContainerWidth())),u.setAttribute("x2",o.FixPoz(e.Rect.x2,e.CW,o.getContainerWidth())),u.setAttribute("y2",o.FixPoz(e.Rect.y2,e.CW,o.getContainerWidth())),t.appendChild(u);var g=o.CreateEle("path");g.setAttribute("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",o.FixPoz(e.Rect.x2,e.CW,o.getContainerWidth()),o.FixPoz(e.Rect.y2,e.CW,o.getContainerWidth()),o.FixPoz(e.Rect.x2,e.CW,o.getContainerWidth())+10,o.FixPoz(e.Rect.y2,e.CW,o.getContainerWidth())+5,o.FixPoz(e.Rect.x2,e.CW,o.getContainerWidth())+10,o.FixPoz(e.Rect.y2,e.CW,o.getContainerWidth())-5)),g.setAttribute("transform",String.format("rotate({0},{1},{2})",s(o.FixPoz(e.Rect.x2,e.CW,o.getContainerWidth()),o.FixPoz(e.Rect.y2,e.CW,o.getContainerWidth()),o.FixPoz(e.Rect.x1,e.CW,o.getContainerWidth()),o.FixPoz(e.Rect.y1,e.CW,o.getContainerWidth())),o.FixPoz(e.Rect.x2,e.CW,o.getContainerWidth()),o.FixPoz(e.Rect.y2,e.CW,o.getContainerWidth()))),g.setAttribute("style","fill:blue;stroke:blue;stroke-width:1"),t.appendChild(g),1==e.Rect.show?$(t).show():$(t).hide()};if(r(e.id)){if((t=r(e.id)).setAttribute("x",this.FixPoz(e.x,e.CW,this.getContainerWidth())),t.setAttribute("y",this.FixPoz(e.y,e.CW,this.getContainerWidth())),t.setAttribute("width",this.FixPoz(e.width,e.CW,this.getContainerWidth())),t.setAttribute("height",this.FixPoz(e.height,e.CW,this.getContainerWidth())),e.Rect){if(!r("g_"+e.id))return void a();var d=$("#g_"+e.id).find(">rect")[0],l=this.FixPoz(e.Rect.x,e.CW,this.getContainerWidth()),h=this.FixPoz(e.Rect.y,e.CW,this.getContainerWidth());d.setAttribute("x",l),d.setAttribute("y",h),d.setAttribute("width",this.FixPoz(e.Rect.width,e.CW,this.getContainerWidth())),d.setAttribute("height",this.FixPoz(e.Rect.height,e.CW,this.getContainerWidth()));var u=$("#g_"+e.id).find(">text")[0];u.setAttribute("x",l+5),u.setAttribute("y",h+15),u.innerHTML="";for(var g=this.SplitText(p(c(e.Rect.text)),this.FixPoz(e.Rect.width,e.CW,this.getContainerWidth())),f=0;f<g.length;f++){var v=this.CreateEle("tspan",{x:l+5,y:h+15+20*f});v.innerHTML=g[f],u.appendChild(v)}var b=$("#g_"+e.id).find(">line")[0];b.setAttribute("x1",this.FixPoz(e.Rect.x1,e.CW,this.getContainerWidth())),b.setAttribute("y1",this.FixPoz(e.Rect.y1,e.CW,this.getContainerWidth())),b.setAttribute("x2",this.FixPoz(e.Rect.x2,e.CW,this.getContainerWidth())),b.setAttribute("y2",this.FixPoz(e.Rect.y2,e.CW,this.getContainerWidth())),b.setAttribute("style","stroke-width:1; stroke:blue;");var x=$("#g_"+e.id).find(">path")[0];x.setAttribute("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",this.FixPoz(e.Rect.x2,e.CW,this.getContainerWidth()),this.FixPoz(e.Rect.y2,e.CW,this.getContainerWidth()),this.FixPoz(e.Rect.x2,e.CW,this.getContainerWidth())+10,this.FixPoz(e.Rect.y2,e.CW,this.getContainerWidth())+5,this.FixPoz(e.Rect.x2,e.CW,this.getContainerWidth())+10,this.FixPoz(e.Rect.y2,e.CW,this.getContainerWidth())-5)),x.setAttribute("transform",String.format("rotate({0},{1},{2})",s(this.FixPoz(e.Rect.x2,e.CW,this.getContainerWidth()),this.FixPoz(e.Rect.y2,e.CW,this.getContainerWidth()),this.FixPoz(e.Rect.x1,e.CW,this.getContainerWidth()),this.FixPoz(e.Rect.y1,e.CW,this.getContainerWidth())),this.FixPoz(e.Rect.x2,e.CW,this.getContainerWidth()),this.FixPoz(e.Rect.y2,e.CW,this.getContainerWidth()))),x.setAttribute("style","fill:blue;stroke:blue;stroke-width:1"),1==e.Rect.show?$("#g_"+e.id).show():$("#g_"+e.id).hide()}}else(t=this.CreateEle("rect",{id:e.id,isdraw:"true",tp:"note",style:"fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;"})).setAttribute("x",this.FixPoz(e.x,e.CW,this.getContainerWidth())),t.setAttribute("y",this.FixPoz(e.y,e.CW,this.getContainerWidth())),t.setAttribute("width",this.FixPoz(e.width,e.CW,this.getContainerWidth())),t.setAttribute("height",this.FixPoz(e.height,e.CW,this.getContainerWidth())),this.Append(t),e.Rect&&a(),$("#"+e.id).bind(this.EVENTCLICK,function(t){$("#g_"+e.id).toggle(),n&&n(r(e.id))}),$("#g_"+e.id).bind(this.EVENTCLICK,function(t){i&&i(e.id,!1)})}}function m(t){v.call(this,"PlayBoard",t);var e=t,i=null;this.SetOnEdit=function(t){i=t};var o=null;this.SetOnRecord=function(t){o=t},this.Play=function(){var t=this,a=function(){if(0!=e.mode)if(1==e.mode)i&&i(r(e.id),e.id,!0);else if(2==e.mode)$("#edit_"+e.id).hide()};if(r(e.id)){var d=r(e.id);if(e.x&&e.CW&&(d.setAttribute("x",t.FixPoz(e.x,e.CW,t.getContainerWidth())),d.setAttribute("y",t.FixPoz(e.y,e.CW,t.getContainerWidth())),d.setAttribute("width",t.FixPoz(e.width,e.CW,t.getContainerWidth())),d.setAttribute("height",t.FixPoz(e.height,e.CW,t.getContainerWidth()))),a(),e.Rect){if(!r("g_"+e.id))return void function(){var i=n("g");i.setAttribute("id","g_"+e.id),i.setAttribute("isdraw","true"),t.Append(i);var o="<div id='div_"+e.id+"' isdraw='true' tabindex='41' style='box-sizing:border-box;border:solid 1px blue; background-color:white; z-index:100; position: absolute; top: "+t.FixPoz(e.Rect.y,e.CW,t.getContainerWidth())+"px; left: "+t.FixPoz(e.Rect.x,e.CW,t.getContainerWidth())+"px; width: "+t.FixPoz(e.Rect.width,e.CW,t.getContainerWidth())+"px; height: "+t.FixPoz(e.Rect.height,e.CW,t.getContainerWidth())+"px; '>";o+="<svg id='svg_"+e.id+"' width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg' xlink='http://www.w3.org/1999/xlink'></svg >",o+="</div>",this.target.parent().append(o);var r=n("line");r.setAttribute("x1",t.FixPoz(e.Rect.x1,e.CW,t.getContainerWidth())),r.setAttribute("y1",t.FixPoz(e.Rect.y1,e.CW,t.getContainerWidth())),r.setAttribute("x2",t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth())),r.setAttribute("y2",t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth())),r.setAttribute("style","stroke-width:1; stroke:blue;"),i.appendChild(r);var a=n("path");a.setAttribute("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth())+10,t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth())+5,t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth())+10,t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth())-5)),a.setAttribute("transform",String.format("rotate({0},{1},{2})",s(t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.x1,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y1,e.CW,t.getContainerWidth())),t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth()))),a.setAttribute("style","fill:blue;stroke:blue;stroke-width:1"),i.appendChild(a),1==e.Rect.show?($(i).show(),$("#div_"+e.id).show()):($(i).hide(),$("#div_"+e.id).hide())}();var l=t.FixPoz(e.Rect.x,e.CW,t.getContainerWidth()),h=t.FixPoz(e.Rect.y,e.CW,t.getContainerWidth());$("#div_"+e.id).css({top:h,left:l,width:t.FixPoz(e.Rect.width,e.CW,t.getContainerWidth()),height:t.FixPoz(e.Rect.height,e.CW,t.getContainerWidth())});var c=$("#g_"+e.id).find(">line")[0];c.setAttribute("x1",t.FixPoz(e.Rect.x1,e.CW,t.getContainerWidth())),c.setAttribute("y1",t.FixPoz(e.Rect.y1,e.CW,t.getContainerWidth())),c.setAttribute("x2",t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth())),c.setAttribute("y2",t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth())),c.setAttribute("style","stroke-width:1; stroke:blue;");var u=$("#g_"+e.id).find(">path")[0];u.setAttribute("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth())+10,t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth())+5,t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth())+10,t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth())-5)),u.setAttribute("transform",String.format("rotate({0},{1},{2})",s(t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.x1,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y1,e.CW,t.getContainerWidth())),t.FixPoz(e.Rect.x2,e.CW,t.getContainerWidth()),t.FixPoz(e.Rect.y2,e.CW,t.getContainerWidth()))),u.setAttribute("style","fill:blue;stroke:blue;stroke-width:1"),1==e.Rect.show?($("#g_"+e.id).show(),$("#div_"+e.id).show()):($("#g_"+e.id).hide(),$("#div_"+e.id).hide())}}else{(d=n("rect")).setAttribute("id",e.id),d.setAttribute("isdraw","true"),d.setAttribute("tp","board"),d.setAttribute("style","fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;"),e.x&&e.CW&&(d.setAttribute("x",t.FixPoz(e.x,e.CW,t.getContainerWidth())),d.setAttribute("y",t.FixPoz(e.y,e.CW,t.getContainerWidth())),d.setAttribute("width",t.FixPoz(e.width,e.CW,t.getContainerWidth())),d.setAttribute("height",t.FixPoz(e.height,e.CW,t.getContainerWidth()))),this.Append(d),a(),t.container.append(t.GetWBContainer(e.id)),$("#"+e.id).bind(t.EVENTCLICK,function(n){t.canEdit&&(o&&o(r(e.id),!0,1),i&&i(r(e.id),e.id,!0))})}},this.GetWBContainer=function(t){this.getViewWidth(),this.getViewHeight();var e=this.getContainerHeight(),i="<div id='edit_"+t+"' class='boardcontainer' tabindex='11' style='position: absolute;box-sizing:border-box;  z-index:103;top:0px; left:0px;width:100%;height:100%;";return i+="background-color:white; border:1px solid #d3d3d3; border-radius:10px; box-shadow: 5px 5px 3px #d3d3d3;display:none;'>",i+="<div class='boardhead' style='height:50px;border-bottom:1px solid #d3d3d3;border-left:1px solid #d3d3d3;border-right:1px solid #d3d3d3;width:100%; z-index:102;background-color:white;position: fixed;display: inline-block;top: 0px;left:0px;'><div style='float:left;height:100%;line-height:50px;padding-top:3px;'><span id='WBTool_Hand_"+t+"' class='WBTool_btn'><img width='20px;' title='Hand' src='"+this.ImagePath+"wb_hand.png' /></span>",i+="<span id='WBTool_Pen_"+t+"' class='WBTool_btn selected'><img width='20px;' title='Pen' src='"+this.ImagePath+"wb_pen.png' /></span><span id='WBTool_Brush_"+t+"' class='WBTool_btn'><img width='20px;' title='Brush' src='"+this.ImagePath+"wb_brush.png' /></span>",i+="<span id='WBTool_Del_"+t+"' class='WBTool_btn'><img width='20px;' title='Delete' src='"+this.ImagePath+"wb_delete.png' /></span>",i+="<span id='WBTool_Undo_"+t+"' class='WBTool_btn'><img width='20px;' title='Undo' src='"+this.ImagePath+"wb_undo.png' /></span><span id='WBTool_Redo_"+t+"' class='WBTool_btn'><img width='20px;' title='Redo' src='"+this.ImagePath+"wb_redo.png' /></span>",i+="</div>",i+="<div style='float:left;height:100%;line-height:50px;padding:2px 0px 0px 10px;'><span id='WBTool_Close_"+t+"' style='cursor:pointer; padding-right:10px;'><img width='20px;' title='Close' src='"+this.ImagePath+"wb_close.png' /></span></div></div><div style='height: 50px;'></div>",i+="<div id='div_"+t+"' style='height:calc(100% - 50px);width:100%;overflow:hidden;position:relative;padding-top:0px;'>",i+="<svg id='svg_"+t+"' width='100%' height='"+3*e+"px' version='1.1' xmlns='http://www.w3.org/2000/svg' xlink='http://www.w3.org/1999/xlink'></svg>",i+="</div></div>"}}function T(t){v.call(this,"PlayVideo",t);var e=t,i=null;this.SetOnEdit=function(t){i=t},this.Play=function(){i(e.id,this.FixPoz(e.Left,e.CW,this.getContainerWidth()),this.FixPoz(e.Top,e.CW,this.getContainerWidth()),e.Info?JSON.stringify(e.Info):"")}}function A(t){var e=this;v.call(this,"PlayMouseMove",t);var i=null,n=t;this.Play=function(){if(i&&(clearTimeout(i),i=null),0!=n.show){if(0==this.container.find("div.liveMouse").length){this.container.append('<div class="liveMouse" style="position: absolute; left: 0px; top: 0px; z-index: 112; margin: -8px 0px 0px -3px; opacity: 0.6; display: none;"><i class="ivu-icon ivu-icon-mouse" style="font-size: 20px; color: red;"></i></div>')}if(this.container.find("div.liveMouse").show(),0==n.delay)this.PlayOnePointer(this.target,n,n.poz.length-1);else for(var t=0;t<n.poz.length;t++)window.setTimeoutEx(this.PlayOnePointer,n.sleep*t,this.target,n,t)}else this.container.find("div.liveMouse").hide()},this.PlayOnePointer=function(t,n,o){if(o<n.poz.length){var r=e.container[0],s=0,a=0;1==n.bd?(s=e.FixPoz(n.poz[o][1]-50,n.VW,e.getViewWidth())+50,a=e.FixPoz(n.poz[o][0],n.VW,e.getViewWidth())):(s=e.FixPoz(n.poz[o][1],n.VW,e.getViewWidth()),a=e.FixPoz(n.poz[o][0],n.VW,e.getViewWidth())),s>e.getViewHeight()+r.scrollTop?r.scrollTop=s-e.getViewHeight()+100:s<r.scrollTop&&(r.scrollTop=Math.max(0,s-100)),0==n.delay?(e.container.find("div.liveMouse").stop().css({top:s,left:a,opacity:0}),e.container.find("div.liveMouse").animate({opacity:.6},300)):e.container.find("div.liveMouse").animate({top:s,left:a,opacity:.6},.95*n.sleep)}else i=setTimeout(function(){e.container.find("div.liveMouse").fadeOut("slow")},1e3)}}function S(t){v.call(this,"PlayMouseClick",t);var e=null,i=t;this.Play=function(){var t=this,n=this.main[0],o=0,r=0;if(1==i.bd?(o=this.FixPoz(i.poz[1]-50,i.VW,this.getViewWidth())+50,r=this.FixPoz(i.poz[0],i.VW,this.getViewWidth())):(o=this.FixPoz(i.poz[1],i.VW,this.getViewWidth()),r=this.FixPoz(i.poz[0],i.VW,this.getViewWidth())),o>this.getViewHeight()+n.scrollTop?n.scrollTop=o-this.getViewHeight()+100:o<n.scrollTop&&(n.scrollTop=Math.max(0,o-100)),e&&(clearTimeout(e),e=null),this.container.find("div.liveMouse").stop().css({top:o,left:r,opacity:.6}),0==this.container.find("div.liveMouseClick").length){this.container.append('<div class="liveMouseClick" style="position:absolute; left: 0px; top: 0px;z-index:113;"><div class="liveMouseContainer"></div></div>')}this.container.find("div.liveMouseClick").css({display:"block",top:o,left:r}),this.container.find("div.liveMouseContainer").removeClass("liveMouseShowAnimation").addClass("liveMouseShowAnimation"),e=setTimeout(function(){t.container.find("div.liveMouseContainer").removeClass("liveMouseShowAnimation"),t.container.find("div.liveMouseClick").hide()},300)}}function W(t,e){v.call(this,"PlayChangeView",t);var i=t,n=null;this.SetOnZoom=function(t){n=t},this.Play=function(){var t=this,o=new Object;o.CW=this.getContainerWidth(),o.CH=this.getContainerHeight(),o.VW=this.getViewWidth(),o.VH=this.getViewHeight(),o.ST=0|this.main.scrollTop(),o.SL=0|this.main.scrollLeft();var r=function(t,e){var i=Object();i.Zoom=t.CW/t.VW,t.ST>0?i.Top=t.ST*e.CW/t.CW:i.Top=0;t.SL>0?i.Left=t.SL*e.CH/t.CH:i.Left=0;return i}(i,o);Math.abs(r.Zoom-e)<.01?(r.Left>=0&&this.main.scrollLeft(r.Left),r.Top>=0&&this.main.scrollTop(r.Top)):n(r.Zoom,function(){r.Left>=0&&t.main.scrollLeft(r.Left),r.Top>=0&&t.main.scrollTop(r.Top)})}}function R(t){v.call(this,"PlayHide",t);var e=t;this.Play=function(){$("#"+this.GetFixedPageNumber(e.id)).hide()}}function _(t){v.call(this,"PlayDelete",t),this.Play=function(){$("#"+this.GetFixedPageNumber(t.id)).remove(),$("#g_"+this.GetFixedPageNumber(t.id)).remove()}}function P(t){v.call(this,"PlayClear",t);var e=t;this.Play=function(){$("#"+this.GetFixedPageNumber(e.id)).find("path,g,circle").remove(),$("#"+this.GetFixedPageNumber(e.id)).find("rect").each(function(t){"board"==$(this).attr("tp")&&$("#edit_"+$(this).attr("id")).remove(),$(this).remove()}),this.container.find("div.live-video-tool-container").remove()}}function E(t){v.call(this,"PlaySelect",t);var e=t;this.Play=function(){if(1==e.stat){var t=$("#"+e.id),i=r(e.id).getBoundingClientRect();i.width+i.height<10?t.attr("class","WB_SelectPathSmall"):t.attr("class","WB_SelectPath")}else $("#"+e.id).removeAttr("class")}}function I(t){v.call(this,"PlayResize",t);var e=t;this.Play=function(){var t=$("#"+this.GetFixedPageNumber(e.id));if(1==e.size)t.height(t.height()+.5*t.parent().height());else if(-1==e.size){if(t.height()<t.parent().height())return;t.height(t.height()-.5*t.parent().height())}}}function z(t){v.call(this,"PlayScroll",t),this.Play=function(){var e=r(t.id);e.scrollTop=t.poz*parseFloat($(e).width())}}function O(t){this.name=t,this.onReocrd=null,this.onSetTool=null,this.onSetActiveTool=null,this.onRecordHistory=null,this.target=null,this.container=null,this.main=null,this.pagenumber=null,this.ele=null,this.canEdit=!0,this.deviceType=0,this.EVENTSTART="mousedown pointerdown",this.EVENTMOVE="mousemove pointermove",this.EVENTEND="mouseup pointerup",this.EVENTRESIZE="onpointerdown",this.EVENTCLICK="click",this.ImagePath="/static/images/";var e=t,i=[0,0];this.Text={Delete:"Delete",Edit:"Edit",Cancel:"Cancel",Save:"Save"},this.SetParamter=function(t,e,i,n,o,r,s,a,d){this.onReocrd=t,this.target=e,this.container=i,this.main=n,this.pagenumber=o,this.deviceType=r,this.onSetTool=s,this.onSetActiveTool=a,this.onRecordHistory=d,0!=this.deviceType&&(this.EVENTSTART="touchstart",this.EVENTMOVE="touchmove",this.EVENTEND="touchend",this.EVENTCLICK="click",this.EVENTRESIZE="ontouchstart",this.ImagePath="img/")},this.SetCanEdit=function(t){this.canEdit=t},this.SetEle=function(t){this.ele=t},this.SetTool=function(t){this.onSetTool&&this.onSetTool(t)},this.SetActiveTool=function(t){this.onSetActiveTool&&this.onSetActiveTool(t)},this.onStart=function(t,e){console.log(this.name+":onStart not done")},this.onMove=function(t,e){console.log(this.name+":onMove not done")},this.onEnd=function(t,i){console.log(e+":onEnd not done")},this.onClick=function(t,e){return!1},this.Record=function(t){console.log(e+":Record not done")},this.Delete=function(){return!1},this.Record_delete=function(t,e){var i=new Object;return i.type=102,i.page=this.pagenumber,i.save=1,i.id=t,this.RecordHandle(i),i},this.Record_clear=function(t,e){var i=new Object;return i.type=103,i.page=this.pagenumber,i.save=1,i.id=t,this.RecordHandle(i),i},this.Record_resize=function(t,e){var i=new Object;return i.type=201,i.page=this.pagenumber,i.id=t,i.size=e,i.CW=this.getContainerWidth(),i.CH=this.getContainerHeight(),this.RecordHandle(i),i},this.Record_scroll=function(t){var e=new Object;return e.type=202,e.page=this.pagenumber,e.id=t,e.poz=r(t).scrollTop/$("#"+t).width(),e.CW=this.getContainerWidth(),e.CH=this.getContainerHeight(),this.RecordHandle(e),e},this.Record_select=function(t,e){var i=new Object;return i.type=104,i.id=t,i.page=this.pagenumber,i.stat=e,this.RecordHandle(i),i},this.RecordHistory_delete=function(t,e){var i=new Object;return i.type=102,i.page=this.pagenumber,i.save=1,i.id=t,i},this.Append=function(){if(this.target[0].firstChild){var t=this.target.find(">path");0==t.length?this.target[0].insertBefore(this.ele,this.target[0].firstChild):t.last().after($(this.ele))}else this.target[0].appendChild(this.ele)},this.getContainerWidth=function(){return this.container.width()},this.getContainerHeight=function(){return this.container.height()},this.getViewHeight=function(){return this.main.height()},this.getViewWidth=function(){return this.main.width()},this.GetFixedPageNumber=function(t){return(t+"").replace(".","\\.")},this.getLastNode=function(t){return t.substr(t.lastIndexOf("L")+1)},this.isInRect=function(t,e,i,n,o){return!(o.y+o.height<e||e+n<o.y||t>o.x+o.width||o.x>t+i)},this._drawGetTop=function(){return $(document).scrollTop()+this.main.scrollTop()-this._drawGetBoundingTop()},this._drawGetLeft=function(){return $(document).scrollLeft()+this.main.scrollLeft()-this._drawGetBoundingLeft()},this._drawGetBoundingLeft=function(){var t=this.container[0].getBoundingClientRect().left;return t=Math.max(t,0)},this._drawGetBoundingTop=function(){var t=this.container[0].getBoundingClientRect().top;return t=Math.max(t,0)},this.CheckRecordStep=function(t,e){var n=Math.abs(t-i[0])+Math.abs(e-i[1])>=100;return n&&(i=[t,e]),n},this.ShowArrow=function(t){var e,i,n,o,r=$("#g_"+t.attr("id")),a=r.find(">line"),d=r.find(">rect"),l=$(r).find("path"),h=parseInt(t.attr("x")),c=parseInt(t.attr("y")),u=parseInt(t.attr("width")),p=parseInt(t.attr("height")),g=parseInt(d.attr("x")),f=parseInt(d.attr("y")),v=parseInt(d.attr("width")),b=parseInt(d.attr("height"));c>f+b?(e=h+u/2,i=c,n=g+v/2,o=f+b):f>c+p?(e=h+u/2,i=c+p,n=g+v/2,o=f):g+v/2>h+u/2?h>g?(e=h,i=c+p/2,n=g,o=f+b/2):(e=h+u,i=c+p/2,n=g,o=f+b/2):h>g+v?(e=h,i=c+p/2,n=g+v,o=f+b/2):(e=h+u,i=c+p/2,n=g+v,o=f+b/2),a.attr("x1",e),a.attr("y1",i),a.attr("x2",n),a.attr("y2",o),l.attr("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",n,o,n+10,o+5,n+10,o-5)),l.attr("transform",String.format("rotate({0},{1},{2})",s(n,o,e,i),n,o)),l.css("z-index","103")},this.SplitText=function(t,e){for(var i=e/8|0,n=new Array,o=function(t){for(var e=new Array,n="";t.length>0;)n+=t[0],t=t.substr(1),n.replace(/[^\x00-\xff]/g,"**").length>=i&&(e.push(n),n="");return""!=n&&e.push(n),e},r=function(t){for(var e=new Array;t.indexOf("\r\n")>-1||t.indexOf("\n")>-1;)t.indexOf("\r\n")>-1?(e.push(t.substring(0,t.indexOf("\r\n")+1)),t=t.substr(t.indexOf("\r\n")+1)):t.indexOf("\n")>-1&&(e.push(t.substring(0,t.indexOf("\n")+1)),t=t.substr(t.indexOf("\n")+1));return""!=t&&e.push(t),e}(t),s=0;s<r.length;s++)for(var a=o(r[s]),d=0;d<a.length;d++)n.push(a[d]);return n},this.RecordHandle=function(t){this.onReocrd&&this.onReocrd(t)},this.CreateRecordBaseInfo=function(t,e,i){i=i||this.ele;var n=new Object;if(n.type=t,n.page=this.pagenumber,n.CW=this.getContainerWidth(),n.CH=this.getContainerHeight(),n.VW=this.getViewWidth(),n.VH=this.getViewHeight(),i&&(n.id=i.getAttributeNode("id").nodeValue),e&&i)for(var o in e)i.getAttributeNode(e[o])&&(n[o]=i.getAttributeNode(e[o]).nodeValue);return n},this.CreateEle=function(t,e){var i=n(t);if(i.setAttribute("id",o()),e)for(var r in e)i.setAttribute(r,e[r]);return i},this.ShowSetting=function(t){},this.ShowColorSizeSetting=function(t,e,i){var n=this,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(i){var r='<div id="WBTool_Setting" tabindex="100" class="WBTool_Setting">\n      <div tabindex="100" style="width:100%; height:25px; padding-top:5px;">\n        <div style="cursor:pointer; float:right;padding-right:10px;" class="WBTool_Close"><img width="20px" title="Close" src="'+this.ImagePath+'wb_close.png"></div>\n      </div>\n      <div style="clear:both;"></div>\n      <div id="WBTool_Setting_Size" tabindex="100" style="width:100%; height:42px;line-height:42px;">\n        <span tabindex="100" class="WBTool_selectsizecontainer" val="1" ><span class="WBTool_selectsize" style="width:6px; height:6px;margin: 17px;"></span></span>\n        <span tabindex="100" class="WBTool_selectsizecontainer" val="2" ><span class="WBTool_selectsize" style="width:10px; height:10px;margin: 15px;"></span></span>\n        <span tabindex="100" class="WBTool_selectsizecontainer" val="3" ><span class="WBTool_selectsize" style="width:14px; height:14px;margin: 13px;"></span></span>\n        <span tabindex="100" class="WBTool_selectsizecontainer" val="6" ><span class="WBTool_selectsize" style="width:18px; height:18px;margin: 11px;"></span></span>\n        <span tabindex="100" class="WBTool_selectsizecontainer" val="10" ><span class="WBTool_selectsize" style="width:22px; height:22px;margin: 9px;"></span></span>\n      </div>\n      <div tabindex="100" style="width:100%; height:40px;">\n        <span tabindex="100" class="WBTool_sizetextcontainer">01</span>\n        <span tabindex="100" class="WBTool_sizetextcontainer">02</span>\n        <span tabindex="100" class="WBTool_sizetextcontainer">03</span>\n        <span tabindex="100" class="WBTool_sizetextcontainer">05</span>\n        <span tabindex="100" class="WBTool_sizetextcontainer">09</span>\n      </div>\n      <div tabindex="100" style="width:100%; height:10px;border-bottom:1px solid #d3d3d3; margin:0px 0px 10px;">\n      </div>\n      <div id="WBTool_Setting_Color" tabindex="100" style="width:100%;">\n        <div tabindex="100" style="width:100%; height:60px; line-height:60px;">\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#ff0000;" val="#ff0000" ><span class="WBTool_selectcolor" style="background-color:#ff0000;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#db5347;" val="#db5347" ><span class="WBTool_selectcolor" style="background-color:#db5347;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#edb34b;" val="#edb34b" ><span class="WBTool_selectcolor" style="background-color:#edb34b;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#ffff00;" val="#ffff00" ><span class="WBTool_selectcolor" style="background-color:#ffff00;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#95e27c;" val="#95e27c" ><span class="WBTool_selectcolor" style="background-color:#95e27c;"></span></span>\n        </div>\n        <div tabindex="100" style="width:100%; height:60px;line-height:60px;">\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#551e79;" val="#551e79" ><span class="WBTool_selectcolor" style="background-color:#551e79;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#010101;" val="#010101" ><span class="WBTool_selectcolor" style="background-color:#010101;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#b8b8ba;" val="#b8b8ba" ><span class="WBTool_selectcolor" style="background-color:#b8b8ba;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#458df3;" val="#458df3" ><span class="WBTool_selectcolor" style="background-color:#458df3;"></span></span>\n          <span tabindex="100" class="WBTool_selectcolorcontainer" style=" border-color:#8cdbf8;" val="#8cdbf8" ><span class="WBTool_selectcolor" style="background-color:#8cdbf8;"></span></span>\n        </div>\n      </div>\n    </div>';$("#WBTool_Setting").length>0&&$("#WBTool_Setting").remove(),this.main.append(r),0==this.deviceType?o&&$("#WBTool_Setting").css({left:"50px",top:"50px"}):o?$("#WBTool_Setting").css({left:"5px",top:"50px"}):$("#WBTool_Setting").css({left:"auto",right:"40px",top:"0px"}),$("#WBTool_Setting").show(),$("#WBTool_Setting_Size").find("span[val='"+t+"']").addClass("selected"),$("#WBTool_Setting_Color").find("span[val='"+e+"']").addClass("selected"),$("#WBTool_Setting").find("div.WBTool_Close").bind(this.EVENTCLICK,function(t){$("#WBTool_Setting").remove(),n.AfterCloseColorSizeSetting(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()}),$("#WBTool_Setting").find("span.WBTool_selectsizecontainer").bind(this.EVENTCLICK,function(t){var e=$(t.currentTarget);e.parent().find("span.selected").removeClass("selected"),e.addClass("selected");var i=parseFloat(e.attr("val"));n.AfterSelectSizeSetting(i),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()}),$("#WBTool_Setting").find("span.WBTool_selectcolorcontainer").bind(this.EVENTCLICK,function(t){var e=$(t.currentTarget);e.parent().parent().find("span.selected").removeClass("selected"),e.addClass("selected");var i=e.attr("val");n.AfterSelectColorSetting(i),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()})}else $("#WBTool_Setting").remove()},this.AfterSelectSizeSetting=function(t){console.log(this.name+":AfterSelectSizeSetting not done")},this.AfterSelectColorSetting=function(t){console.log(this.name+":AfterSelectSizeSetting not done")},this.AfterCloseColorSizeSetting=function(){console.log(this.name+":AfterCloseColorSizeSetting not done")}}function V(){O.call(this,"ToolPen");var t=1,e="#ff0000";this.onStart=function(i,n){this.ele=this.CreateEle("path",{isdraw:"true",tp:"line",style:"fill:white;fill-opacity:0;stroke-linecap:round;","stroke-width":t,stroke:e}),this.ele.setAttribute("d","M"+i+","+n),this.Append(),this.Record()},this.onMove=function(i,n){var o=this.ele.getAttributeNode("d").nodeValue;return o.length>8870?(this.Record(!0),this.ele=this.CreateEle("path",{isdraw:"true",tp:"line",style:"fill:white;fill-opacity:0;stroke-linecap:round;","stroke-width":t,stroke:e}),this.ele.setAttribute("d","M"+this.getLastNode(o)+" L"+i+","+n),this.Append(),this.Record()):this.ele.setAttribute("d",o+" L"+i+","+n),this.CheckRecordStep(i,n)&&this.Record(),!0},this.onEnd=function(t,e){var i=this.ele.getAttributeNode("d").nodeValue;-1==i.indexOf("L")&&this.ele.setAttribute("d",i+" L"+i.substr(i.indexOf("M")+1));var n=this.Record(!0);return this.onRecordHistory&&this.onRecordHistory(this.RecordHistory_delete(n.id),n),!0},this.Record=function(t){var e=this.CreateRecordBaseInfo(21,{d:"d",w:"stroke-width",color:"stroke",op:"stroke-opacity"});return t&&(e.save=1),e.tar="",this.RecordHandle(e),e},this.ShowSetting=function(i){this.ShowColorSizeSetting(t,e,i)},this.AfterSelectSizeSetting=function(e){t=e},this.AfterSelectColorSetting=function(t){e=t}}function k(){O.call(this,"ToolLine");var t="#ff0000",e=1;this.onStart=function(i,n){this.ele=this.CreateEle("path",{isdraw:"true",tp:"sline",style:"fill:white;fill-opacity:0;","stroke-width":e,stroke:t}),this.ele.setAttribute("d","M"+i+","+n),this.Append(),this.Record()},this.onMove=function(t,e){var i=this.ele.getAttributeNode("d").nodeValue;return i.indexOf("L")>-1&&(i=i.substr(0,i.indexOf("L")-1)),this.ele.setAttribute("d",i+" L"+t+","+e),this.CheckRecordStep(t,e)&&this.Record(),!0},this.onEnd=function(t,e){var i=this.ele.getAttributeNode("d").nodeValue;-1==i.indexOf("L")&&this.ele.setAttribute("d",i+" L"+i.substr(i.indexOf("M")+1));var n=this.Record(!0);return this.onRecordHistory&&this.onRecordHistory(this.RecordHistory_delete(n.id),n),!0},this.Record=function(t){var e=this.CreateRecordBaseInfo(24,{d:"d",w:"stroke-width",color:"stroke"});return t&&(e.save=1),this.RecordHandle(e),e},this.ShowSetting=function(i){this.ShowColorSizeSetting(e,t,i)},this.AfterSelectSizeSetting=function(t){e=t},this.AfterSelectColorSetting=function(e){t=e}}function N(){O.call(this,"ToolBrush");var t=6,e="#ffff00";this.onStart=function(i,n){this.ele=this.CreateEle("path",{isdraw:"true",tp:"brush",style:"fill-opacity:0;stroke-opacity:0.5;stroke-linecap:round;","stroke-width":1+4*t,stroke:e}),this.ele.setAttribute("d","M"+i+","+n),this.Append(),this.Record()},this.onMove=function(t,e){var i=this.ele.getAttributeNode("d").nodeValue;return this.ele.setAttribute("d",i+" L"+t+","+e),this.CheckRecordStep(t,e)&&this.Record(),!0},this.onEnd=function(t,e){var i=this.ele.getAttributeNode("d").nodeValue;-1==i.indexOf("L")&&this.ele.setAttribute("d",i+" L"+i.substr(i.indexOf("M")+1));var n=this.Record(!0);return this.onRecordHistory&&this.onRecordHistory(this.RecordHistory_delete(n.id),n),!0},this.Record=function(t){var e=this.CreateRecordBaseInfo(25,{d:"d",w:"stroke-width",color:"stroke"});return t&&(e.save=1),e.tar="",this.RecordHandle(e),e},this.ShowSetting=function(i){this.ShowColorSizeSetting(t,e,i)},this.AfterSelectSizeSetting=function(e){t=e},this.AfterSelectColorSetting=function(t){e=t}}function H(){O.call(this,"ToolText");var t=12,e="#ff0000";this.onStart=function(t,e){this.ele=this.CreateEle("rect",{isdraw:"true",tp:"text",style:"fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;",width:0,height:0}),this.ele.setAttribute("x",t),this.ele.setAttribute("y",e),this.ele.setAttribute("sx",t),this.ele.setAttribute("sy",e),this.Append(),this.Record()},this.onMove=function(t,e){var i=parseInt(this.ele.getAttributeNode("sx").nodeValue),n=parseInt(this.ele.getAttributeNode("sy").nodeValue),o=t-i,r=e-n;return o>=0&&r>=0?(this.ele.setAttribute("width",o),this.ele.setAttribute("height",r)):o<0&&r<0?(this.ele.setAttribute("x",i+o),this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",-r)):o>=0&&r<0?(this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",o),this.ele.setAttribute("height",-r)):o<0&&r>=0&&(this.ele.setAttribute("x",i+o),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",r)),!0},this.onEnd=function(t,e){var i=this;this.ele.setAttribute("style","fill:blue;stroke:blue;stroke-width:0;fill-opacity:0;");t=parseInt(this.ele.getAttributeNode("x").nodeValue),e=parseInt(this.ele.getAttributeNode("y").nodeValue);var n=parseInt(this.ele.getAttributeNode("width").nodeValue),o=parseInt(this.ele.getAttributeNode("height").nodeValue);if(n<20&&o<20)return $(this.ele).remove(),!1;var r=this.ele.getAttributeNode("id").nodeValue;this.addNote(t,e,n,o,r);var s=$("#"+r);$("#"+r+",#g_"+r).bind(this.EVENTCLICK,function(t){i.EidtText(s,!1)});this.Record(!0);return this.EidtText($("#"+r),!0),this.SetTool(""),!0},this.Delete=function(){if(this.SetActiveTool(null),!this.ele)return!1;var t=this.Record(!0,!1);if(this.onRecordHistory){var e=new Array;e.push(this.RecordHistory_delete(t.id)),e.push(this.RecordHistory_delete("g_"+t.id)),this.onRecordHistory(t,e)}var i=this.ele.id;return this.Record_delete(i),this.Record_delete("g_"+i),$("#"+i).remove(),$("#edit_"+i).remove(),$("#g_"+i).remove(),$("#editnote").hide(),!0},this.addNote=function(t,e,i,n,o){var r=this.CreateEle("g",{isdraw:"true",id:"g_"+o});this.target.append(r);var s=this.CreateEle("text",{x:t+1,y:e+10,style:"fill:red;font-size:14px;font-family: 'Consolas';"});s.innerHTML="",r.appendChild(s)},this.EidtText=function(t,e){var i=this,n=12;0!=this.deviceType&&(n=25);var o=$("#g_"+$(t).attr("id")).find("text"),r=$(t),s=parseInt(r.attr("x")),a=parseInt(r.attr("y")),d=parseInt(r.attr("width")),l=parseInt(r.attr("height")),h='<div id="editnote" style="position:absolute; left:10px; top:10px; float:left; z-index:201;">\n        <div class="editnotemenu" style="background-color:black;border-radius:5px; color:white; height:24px;">\n          <ul>\n            <li id="editnote_delete">'+this.Text.Delete+'</li>\n            <li id="editnote_edit">'+this.Text.Edit+'</li>\n          </ul>\n        </div>\n        <div style="padding:8px 0px 0px 20px; text-align:left;">\n          <span style="width:0;height:0;border-left: 5px solid transparent;border-right: 5px solid transparent;border-top: 10px solid black;"></span>\n        </div>\n      </div>';$("#editnote").length>0&&$("#editnote").remove(),this.main.append(h),$("#editnote").attr("tar",t.attr("id")).attr("tp","text").css({left:s-this._drawGetLeft()+"px",top:a-this._drawGetTop()-50+this.main.scrollTop()+"px"}).show();var c="<div id='edit_"+$(t).attr("ID")+"' tabindex='21' style='position: absolute;touch-action: none; z-index:100; box-sizing:border-box; top: "+(a-n)+"px; left: "+(s-n)+"px; width: "+(d+2*n)+"px; height: "+(l+2*n)+"px; '><table style='width:100%;height:100%;' cellspacing='0' cellpadding='0' border='0'><tr style='height:"+n+"px;'><td "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'nw', 80, 80);\" style='width:"+n+"px;' class='resizebg_nw'></td><td></td><td style='width:"+n+"px;' class='resizebg_ne' "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'ne', 80, 80);\"></td></tr><tr><td></td><td style='height:100%;'><div style=\"cursor:move;width:100%;height:100%;border:1px solid blue; text-align:left; padding:0px 0px 0px 2px;background-color:white;box-sizing:border-box;word-break:break-all; font-size:14px;font-family: 'Consolas';\" class='container'>";c+=o.text().replace(/\r\n/gi,"<br />").replace(/\n/gi,"<br />"),c+="</div>",c+="</td><td></td></tr><tr style='height:"+n+"px;'><td "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'sw', 80, 80);\" style='width:"+n+"px;' class='resizebg_sw'></td><td></td><td style='width:"+n+"px;' class='resizebg_se' "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'se', 80, 80);\"></td></tr><table></div></div>",this.container.append(c);var u=$("#edit_"+$(t).attr("ID"));Drag.init(u.find("div.container")[0],u[0],-n,null,-n,null);var p=null;u[0].onDrag=function(){null==p&&(p=i.Record(!0,!1)),$("#editnote").hide();var t=parseInt(u[0].style.left)+n,e=parseInt(u[0].style.top)+n,o=parseInt(u[0].style.width)-2*n,s=parseInt(u[0].style.height)-2*n;r.attr("x",t),r.attr("y",e),r.attr("width",o),r.attr("height",s)},u[0].onDragEnd=function(){var t=parseInt(u[0].style.left)+n,e=parseInt(u[0].style.top)+n,s=parseInt(u[0].style.width)-2*n,a=parseInt(u[0].style.height)-2*n;r.attr("x",t),r.attr("y",e),r.attr("width",s),r.attr("height",a),o.attr("x",t+1),o.attr("y",e+1),o.find("tspan").each(function(i){$(this).attr("x",t+1),$(this).attr("y",e+10+20*i)}),$("#editnote").css({left:t-i._drawGetLeft()+"px",top:e-50-i._drawGetTop()+i.main.scrollTop()+"px"}).show();var d=i.Record(!0);null!=p&&(i.onRecordHistory(p,d),p=null)},u[0].onSizeChange=function(){null==p&&(p=i.Record(!0,!1)),$("#editnote").hide(),l=parseInt(u[0].style.height),u.find("div.editor").height(l-43)},u[0].onSizeChanged=function(){null==p&&(p=i.Record(!0,!1)),$("#editnote").hide();var e=parseInt(u[0].style.left),o=parseInt(u[0].style.top),s=parseInt(u[0].style.width),a=parseInt(u[0].style.height);r.attr("x",e+n),r.attr("y",o+n),r.attr("width",s-2*n),r.attr("height",a-2*n),$("#editnote").css({left:e+n-i._drawGetLeft()+"px",top:o+n-50-i._drawGetTop()+i.main.scrollTop()+"px"}).show(),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")));var d=i.Record(!0);null!=p&&(i.onRecordHistory(p,d),p=null)},$("#g_"+$(t).attr("id")).hide(),$(t).hide();var g=function(){var e=o.text();if(""!=Trim(e)){s=r.attr("x"),a=r.attr("y");var n=parseInt(r.attr("width")),d=i.SplitText(e,n);o.html("");for(var l=0;l<d.length;l++){var h=i.CreateEle("tspan");h.setAttribute("x",parseInt(s,10)+1),h.setAttribute("y",parseInt(a,10)+10+20*l),h.innerHTML=d[l],o.append(h)}u.remove(),t.show(),$("#g_"+$(t).attr("id")).show(),$("#editnote").hide();i.Record(!0);i.SetActiveTool(null)}else f()},f=function(){var e=i.Record(!0,!1);if(i.onRecordHistory){var n=new Array;n.push(i.RecordHistory_delete(e.id)),n.push(i.RecordHistory_delete("g_"+e.id)),i.onRecordHistory(e,n)}b&&clearTimeout(b),i.Record_delete($(t).attr("id")),i.Record_delete("g_"+$(t).attr("id")),u.remove(),t.remove(),$("#g_"+$(t).attr("id")).remove(),$("#editnote").hide(),i.SetActiveTool(null)},v=function(t){var e=i.Record(!0,!1);$("#editnotetext").hide();var n=$("#editnote_content").val(),o=$("#editnote").attr("tar"),r=($("#editnote").attr("tp"),$("#"+o)),s=parseInt(r.attr("width")),a=i.SplitText(n,s),d=$("#g_"+o).find("text"),l=d.attr("x"),h=d.attr("y");d.html("");for(var c=0;c<a.length;c++){var u=i.CreateEle("tspan");u.setAttribute("x",parseInt(l,10)+5),u.setAttribute("y",parseInt(h,10)+5+20*c),u.innerHTML=a[c],d.append(u)}var p=i.Record(!0);i.onRecordHistory(e,p),$("#editnotetext").remove(),i.SetActiveTool(null)},b=null;u.bind("blur",function(){b&&clearTimeout(b),b=setTimeout(g,300)}).bind("focus",function(){b&&clearTimeout(b)}),$("#editnote").unbind().bind("click",function(e){switch($(e.originalEvent.target).attr("id")){case"editnote_delete":f();break;case"editnote_edit":!function(e){b&&clearTimeout(b),u.remove(),t.show(),$("#g_"+$(t).attr("id")).show(),$("#editnote").hide();var n='<div id="editnotetext" tabindex="51" style="position:absolute; z-index:20000; left:0px; top:0px; width:500px; height:400px; padding:2px; background-color:white; border:solid 1px #000;">\n                <div style="width:100%; height:100%;">\n                <div style="height:40px; width:100%; text-align:left;">\n                    <span style="border:1px solid #ccc;border-radius: 4px;cursor:pointer;display:inline-block;padding:5px;" id="btnCancelNote">'+i.Text.Cancel+'</span>\n                    <span style=" float:right;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;padding:5px;" id="btnSaveNote">'+i.Text.Save+'</span>\n                </div>\n                <div style="width:100%;">\n                    <textarea style="width:100%; height:360px;resize:none;overflow-y:auto;font-family: \'Consolas\';" rows="10" id="editnote_content"></textarea>\n                </div>\n                </div>\n            </div>';$("#editnotetext").length>0&&$("#editnotetext").remove(),i.main.append(n);var r=s,d=-i._drawGetTop()+a;r=Math.max(0,r),d=Math.max(0,d),r=Math.min(i.getViewWidth()-510,r),d=Math.min(i.getViewHeight()-410,d),$("#editnotetext").show().css({left:r+"px",top:d+"px"}),0!=i.deviceType&&$("#editnotetext").css({left:"0px",top:"0px",width:"calc(100% - 8px)",height:"100%"}),$("#editnote_content").val(o.text()).focus(),$("#btnSaveNote").bind(i.EVENTCLICK,v),$("#btnCancelNote").bind(i.EVENTCLICK,function(t){$("#editnotetext").remove()}),i.SetActiveTool(null)}();break;case"editnote_color":case"editnote_fontsize":break;default:b&&clearTimeout(b)}}),u.focus(),this.SetActiveTool(this)},this.Record=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.CreateRecordBaseInfo(28,{x:"x",y:"y",width:"width",height:"height"});if(r("g_"+i.id)){var n=$("#g_"+i.id),o=n.find("text");i.Rect=new Object,i.Rect.x=parseInt(o.attr("x")),i.Rect.y=parseInt(o.attr("y")),i.Rect.text=h(u(n.find("text").text()))}return t&&(i.save=1),i.tar="",e&&this.RecordHandle(i),i},this.ShowSetting=function(i){this.ShowColorSizeSetting(t,e,i)},this.AfterSelectSizeSetting=function(e){t=e},this.AfterSelectColorSetting=function(t){e=t}}function B(){O.call(this,"ToolNote");var t=12,e="#ff0000";this.onStart=function(t,e){this.ele=this.CreateEle("rect",{isdraw:"true",tp:"note",style:"fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;z-index:102;",width:0,height:0}),this.ele.setAttribute("x",t),this.ele.setAttribute("y",e),this.ele.setAttribute("sx",t),this.ele.setAttribute("sy",e),this.Append(),this.Record()},this.onMove=function(t,e){var i=parseInt(this.ele.getAttributeNode("sx").nodeValue),n=parseInt(this.ele.getAttributeNode("sy").nodeValue),o=t-i,r=e-n;return o>=0&&r>=0?(this.ele.setAttribute("width",o),this.ele.setAttribute("height",r)):o<0&&r<0?(this.ele.setAttribute("x",i+o),this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",-r)):o>=0&&r<0?(this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",o),this.ele.setAttribute("height",-r)):o<0&&r>=0&&(this.ele.setAttribute("x",i+o),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",r)),!0},this.onEnd=function(t,e){var i=this,n=(t=parseInt(this.ele.getAttributeNode("x").nodeValue),e=parseInt(this.ele.getAttributeNode("y").nodeValue),parseInt(this.ele.getAttributeNode("width").nodeValue)),o=parseInt(this.ele.getAttributeNode("height").nodeValue);if(n<20&&o<20)return $(this.ele).remove(),!1;var r=this.ele.getAttributeNode("id").nodeValue;this.addNote(t,e,n,o,r);var s=$("#g_"+r);$("#"+r).bind(this.EVENTCLICK,function(t){$("#g_"+r).toggle(),i.Record(!0)}),$(s).bind(this.EVENTCLICK,function(t){i.EidtAnnotation(s,!1)});var a=this.Record(!0);return this.onRecordHistory&&this.onRecordHistory(this.RecordHistory_delete(a.id),a),this.EidtAnnotation($("#g_"+r),!0),this.SetTool(""),!0},this.Delete=function(){if(this.SetActiveTool(null),!this.ele)return!1;var t=this.Record(!0,!1);this.onRecordHistory&&this.onRecordHistory(t,this.RecordHistory_delete(t.id));var e=this.ele.id;return this.Record_delete(e),$("#"+e).remove(),$("#orp_"+e).remove(),$("#or_"+e).remove(),$("#g_"+e).remove(),$("#editnote").hide(),!0},this.addNote=function(t,e,i,n,o){var r,a,d,l,h=0,c=0,u=this.getContainerWidth();console.log("addNote left:0"),e-0>=270?(t+i/2-0>u/2?((h=t+i-0-200)<10&&(h=10),c=e-120-50):((h=t+i/2)+200+10>u&&(h=u-200-10),c=e-120-50),d=h+100,l=c+120,r=t+i/2,a=e):(t+i/2-0>u/2?((h=t+i-0-200)<10&&(h=10),c=e+n+50):((h=t+i/2)+200+10>u&&(h=u-200-10),c=e+n+50),d=h+100,l=c,r=t+i/2,a=e+n);var p=this.CreateEle("g");p.setAttribute("id","g_"+o),p.setAttribute("isdraw","true"),this.target.append(p);var g=this.CreateEle("rect");g.setAttribute("style","fill:white;stroke:blue;stroke-width:1;fill-opacity:0.3;"),g.setAttribute("x",h),g.setAttribute("y",c),g.setAttribute("width",200),g.setAttribute("height",120),p.appendChild(g);var f=this.CreateEle("text");f.setAttribute("x",h+5),f.setAttribute("y",c+5),f.setAttribute("style","fill:rgb(0,0,0);font-size:14px;font-family: 'Consolas';"),f.innerHTML="",p.appendChild(f);for(var v=this.SplitText("",200),b=0;b<v.length;b++){var x=this.CreateEle("tspan");x.setAttribute("x",h+5),x.setAttribute("y",c+15+20*b),x.innerHTML=v[b],f.append(x)}var y=this.CreateEle("line");y.setAttribute("x1",r),y.setAttribute("y1",a),y.setAttribute("x2",d),y.setAttribute("y2",l),y.setAttribute("style","stroke-width:1; stroke:blue;"),p.appendChild(y);var w=this.CreateEle("path");w.setAttribute("d",String.format("M{0} {1} L{2} {3} L{4} {5} Z",d,l,d+10,l+5,d+10,l-5)),w.setAttribute("transform",String.format("rotate({0},{1},{2})",s(d,l,r,a),d,l)),w.setAttribute("style","fill:blue;stroke:blue;stroke-width:1"),p.appendChild(w)},this.EidtAnnotation=function(t,e){var i=this,n=12;0!=this.deviceType&&(n=25);var o=$(t).find("rect"),r=$(t).find("text"),s=parseInt(o.attr("x")),a=parseInt(o.attr("y")),d=parseInt(o.attr("width")),l=parseInt(o.attr("height")),h='<div id="editnote" style="position:absolute; left:10px; top:10px; float:left; z-index:201;">\n        <div class="editnotemenu" style="background-color:black;border-radius:5px; color:white; height:24px;">\n          <ul>\n            <li id="editnote_delete">'+this.Text.Delete+'</li>\n            <li id="editnote_edit">'+this.Text.Edit+'</li>\n          </ul>\n        </div>\n        <div style="padding:8px 0px 0px 20px; text-align:left;">\n          <span style="width:0;height:0;border-left: 5px solid transparent;border-right: 5px solid transparent;border-top: 10px solid black;"></span>\n        </div>\n      </div>';$("#editnote").length>0&&$("#editnote").remove(),this.main.append(h),$("#editnote").attr("tar",t.attr("id").replace("g_","")).attr("tp","note").css({left:s-this._drawGetLeft()+"px",top:Math.max(0,a-0-40-this._drawGetTop()+this.main.scrollTop())+"px"}).show();var c="<div id='edit_"+$(t).attr("ID")+"' tabindex='21' style='position: absolute;touch-action: none;z-index:100;box-sizing:border-box; top: "+(a-n)+"px; left: "+(s-n)+"px; width: "+(d+2*n)+"px; height: "+(l+2*n)+"px; '><table style='width:100%;height:100%;' cellspacing='0' cellpadding='0' border='0'><tr style='height:"+n+"px;'><td "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'nw', 50, 50);\" style='width:"+n+"px;' class='resizebg_nw'></td><td></td><td style='width:"+n+"px;' class='resizebg_ne' "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'ne', 50, 50);\"></td></tr><tr><td></td><td style='height:100%;'><div style=\"width:100%;height:100%;border:1px solid blue; text-align:left; padding:5px;background-color:white;box-sizing:border-box;font-family: 'Consolas';font-size:14px;opacity:0.5;\" class='container'>";c+=r.text().replace(/\r\n/gi,"<br />").replace(/\n/gi,"<br />"),c+="</div>",c+="</td><td></td></tr><tr style='height:"+n+"px;'><td "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'sw', 50, 50);\" style='width:"+n+"px;' class='resizebg_sw'></td><td></td><td style='width:"+n+"px;' class='resizebg_se' "+this.EVENTRESIZE+"=\"Resize(document.getElementById('edit_"+$(t).attr("ID")+"'), event, 'se', 50, 50);\"></td></tr><table></div></div>",this.container.append(c);var u=$("#edit_"+$(t).attr("ID"));Drag.init(u.find("div.container")[0],u[0],-n,null,-n,null);var p=null;u[0].onDrag=function(){null==p&&(p=i.Record(!0,!1)),$("#editnote").hide();var e=parseInt(u[0].style.left)+n,r=parseInt(u[0].style.top)+n,s=parseInt(u[0].style.width)-2*n,a=parseInt(u[0].style.height)-2*n;o.attr("x",e),o.attr("y",r),o.attr("width",s),o.attr("height",a),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")))},u[0].onDragEnd=function(){var e=parseInt(u[0].style.left)+n,s=parseInt(u[0].style.top)+n,a=parseInt(u[0].style.width)-2*n,d=parseInt(u[0].style.height)-2*n;o.attr("x",e),o.attr("y",s),o.attr("width",a),o.attr("height",d),r.attr("x",e+5),r.attr("y",s+15),r.find("tspan").each(function(t){$(this).attr("x",e+5),$(this).attr("y",s+15+20*t)}),$("#editnote").css({left:e-i._drawGetLeft()+"px",top:Math.max(0,s-0-40-i._drawGetTop()+i.main.scrollTop())+"px"}).show(),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")));var l=i.Record(!0);console.log(p),null!=p&&(i.onRecordHistory(p,l),p=null)},u[0].onSizeChange=function(){null==p&&(p=i.Record(!0,!1)),$("#editnote").hide(),l=parseInt(u[0].style.height),u.find("div.editor").height(l-43)},u[0].onSizeChanged=function(){null==p&&(p=i.Record(!0,!1)),$("#editnote").hide();var e=parseInt(u[0].style.left),s=parseInt(u[0].style.top),a=parseInt(u[0].style.width),d=parseInt(u[0].style.height);o.attr("x",e+n),o.attr("y",s+n),o.attr("width",a-2*n),o.attr("height",d-2*n),r.find("tspan").each(function(t){$(this).attr("x",e+n+5),$(this).attr("y",s+n+15+20*t)}),$("#editnote").css({left:e+n-i._drawGetLeft()+"px",top:Math.max(0,s+n-0-40-i._drawGetTop()+i.main.scrollTop())+"px"}).show(),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")));var l=i.Record(!0);null!=p&&(i.onRecordHistory(p,l),p=null)};var g=function(){var e=i.Record(!0,!1),n=$("#editnote_content").val();s=o.attr("x"),a=o.attr("y");var d=parseInt(o.attr("width")),l=i.SplitText(n,d);r.html("");for(var h=0;h<l.length;h++){var c=i.CreateEle("tspan");c.setAttribute("x",parseInt(s,10)+5),c.setAttribute("y",parseInt(a,10)+15+20*h),c.innerHTML=l[h],r.append(c)}u.remove(),C.remove(),m.remove(),$("#editnotetext").remove(),f.show(),$(t).find("rect,text").show(),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")));var p=i.Record(!0);i.onRecordHistory(e,p)};u.find("#cancel").bind(this.EVENTCLICK,function(){u.remove(),$(t).find("rect,text").show()}),$(t).find("rect,text").hide();var f=$("#"+$(t).attr("ID").replace("g_","")),v=f.attr("x"),b=f.attr("y"),x=parseInt(f.attr("width")),y=parseInt(f.attr("height")),w="<div id='orp_"+f.attr("ID")+"' tabindex='22' style='position: absolute;touch-action: none;z-index:101;box-sizing:border-box; top: "+(b-n)+"px; left: "+(v-n)+"px; width: "+(x+2*n)+"px; height: "+(y+2*n)+"px; '>";w+="<table style='width:100%;height:100%;' cellspacing='0' cellpadding='0' border='0'><tr style='height:"+n+"px;'><td "+this.EVENTRESIZE+"=\"Resize(document.getElementById('orp_"+f.attr("ID")+"'), event, 'nw', 50, 50);\" style='width:"+n+"px;' class='resizebg_nw'></td><td></td><td style='width:"+n+"px;' class='resizebg_ne' "+this.EVENTRESIZE+"=\"Resize(document.getElementById('orp_"+f.attr("ID")+"'), event, 'ne', 50, 50);\"></td></tr><tr><td></td><td style='height:100%;'>",w+="<div id='or_"+f.attr("ID")+"' style='width:100%;height:100%;border:1px solid blue;box-sizing:border-box;'></div>",w+="</td><td></td></tr><tr style='height:"+n+"px;'><td "+this.EVENTRESIZE+"=\"Resize(document.getElementById('orp_"+f.attr("ID")+"'), event, 'sw', 50, 50);\" style='width:"+n+"px;' class='resizebg_sw'></td><td></td><td style='width:"+n+"px;' class='resizebg_se' "+this.EVENTRESIZE+"=\"Resize(document.getElementById('orp_"+f.attr("ID")+"'), event, 'se', 50, 50);\"></td></tr><table>",w+="</div>",this.container.append(w);var C=$("#or_"+$(f).attr("ID")),m=$("#orp_"+$(f).attr("ID"));Drag.init(C[0],m[0],-n,null,-n,null);var T=null;m[0].onSizeChange=function(){null==T&&(T=i.Record(!0,!1))},m[0].onSizeChanged=function(){null==T&&(T=i.Record(!0,!1));var e=parseInt(m[0].style.left),o=parseInt(m[0].style.top),r=parseInt(m[0].style.width),s=parseInt(m[0].style.height);f.attr("x",e+n),f.attr("y",o+n),f.attr("width",r-2*n),f.attr("height",s-2*n),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")));var a=i.Record(!0);null!=T&&(i.onRecordHistory(T,a),T=null)},m[0].onDrag=function(){null==T&&(T=i.Record(!0,!1));var e=parseInt(m[0].style.left)+n,o=parseInt(m[0].style.top)+n,r=parseInt(m[0].style.width)-2*n,s=parseInt(m[0].style.height)-2*n;f.attr("x",e),f.attr("y",o),f.attr("width",r),f.attr("height",s),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")))},m[0].onDragEnd=function(){var e=parseInt(m[0].style.left)+n,o=parseInt(m[0].style.top)+n,r=parseInt(m[0].style.width)-2*n,s=parseInt(m[0].style.height)-2*n;f.attr("x",e),f.attr("y",o),f.attr("width",r),f.attr("height",s),i.ShowArrow($("#"+$(t).attr("ID").replace("g_","")));var a=i.Record(!0);null!=T&&(i.onRecordHistory(T,a),T=null)},f.hide();var A=function(){s=parseInt(o.attr("x")),a=parseInt(o.attr("y"));parseInt(o.attr("width"));u.remove(),C.remove(),m.remove(),f.show(),$("#editnote").hide(),$(t).find("rect,text").show(),i.ShowArrow($("#"+$(t).attr("ID").replace("g_",""))),i.Record(),i.SetActiveTool(null)};u.focus();var S=null;u.bind("blur",function(){S&&clearTimeout(S),S=setTimeout(A,300)}).bind("focus",function(){S&&clearTimeout(S)}),m.bind("blur",function(){S&&clearTimeout(S),S=setTimeout(A,300)}).bind("focus",function(){S&&clearTimeout(S)}),$("#editnote").unbind().bind("click",function(e){var n;switch($(e.originalEvent.target).attr("id")){case"editnote_delete":n=i.Record(!0,!1),i.onRecordHistory&&i.onRecordHistory(n,i.RecordHistory_delete(n.id)),S&&clearTimeout(S),i.Record_delete(t.attr("id").replace("g_","")),u.remove(),C.remove(),m.remove(),f.remove(),t.remove(),$("#editnote").hide(),i.SetActiveTool(null);break;case"editnote_edit":!function(){A();$(document.body).height();var e='<div id="editnotetext" tabindex="51" style="position:absolute; z-index:20000; left:0px; top:0px; width:500px; height:400px; padding:2px; background-color:white; border:solid 1px #000;">\n                <div style="width:100%; height:100%;">\n                <div style="height:40px; width:100%; text-align:left;">\n                    <span style="border:1px solid #ccc;border-radius: 4px;cursor:pointer;display:inline-block;padding:5px;" id="btnCancelNote">'+i.Text.Cancel+'</span>\n                    <span style=" float:right;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;padding:5px;" id="btnSaveNote">'+i.Text.Save+'</span>\n                </div>\n                <div style="width:100%;">\n                    <textarea style="width:100%; height:360px;resize:none;overflow-y:auto;font-family: \'Consolas\';" rows="10" id="editnote_content"></textarea>\n                </div>\n                </div>\n            </div>';$("#editnotetext").length>0&&$("#editnotetext").remove(),i.main.append(e);var n=s,o=-i._drawGetTop()+a;n=Math.max(0,n),o=Math.max(0,o),n=Math.min(i.getViewWidth()-510,n),o=Math.min(i.getViewHeight()-410,o),$("#editnotetext").show().css({left:n+"px",top:o+"px"}),0!=i.deviceType&&$("#editnotetext").css({left:"0px",top:"0px",width:"calc(100% - 8px)",height:"100%"}),$("#editnote_content").val(r.text()).focus(),$("#btnSaveNote").bind(i.EVENTCLICK,g),$("#btnCancelNote").bind(i.EVENTCLICK,function(e){$("#editnotetext").remove(),u.remove(),$(t).find("rect,text").show()}),i.SetActiveTool(null)}();break;case"editnote_color":case"editnote_fontsize":break;default:S&&clearTimeout(S)}}),this.SetActiveTool(this)},this.Record=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.CreateRecordBaseInfo(26,{x:"x",y:"y",width:"width",height:"height"});if(r("g_"+i.id)){var n=$("#g_"+i.id),o=n.find("rect");i.Rect=new Object,i.Rect.show="none"!=n.css("display"),i.Rect.x=parseInt(o.attr("x")),i.Rect.y=parseInt(o.attr("y")),i.Rect.width=parseInt(o.attr("width")),i.Rect.height=parseInt(o.attr("height")),i.Rect.text=h(u(n.find("text").text()));var s=n.find("line");i.Rect.x1=parseInt(s.attr("x1")),i.Rect.x2=parseInt(s.attr("x2")),i.Rect.y1=parseInt(s.attr("y1")),i.Rect.y2=parseInt(s.attr("y2"))}return t&&(i.save=1),e&&this.RecordHandle(i),i},this.ShowSetting=function(i){this.ShowColorSizeSetting(t,e,i)},this.AfterSelectSizeSetting=function(e){t=e},this.AfterSelectColorSetting=function(t){e=t}}function F(){O.call(this,"ToolBoard");var t=.5,e="#ff0000",i=null,o=null,s=(new Array,new Array,new Array,new f),a=new Array,d=null;function l(t){var e=$(t.originalEvent.target),i=t.originalEvent;return"media-header"!=e.attr("id")&&"media-panel-actions"!=e.attr("id")&&("svg"==e[0].tagName.toLowerCase()||"svg"==e.parent()[0].tagName.toLowerCase())&&(!i.pointerType||"mouse"!=i.pointerType||(1==i.button||0==i.button||-1==i.button))}function h(t){t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()}function c(t){$("#svg_"+t).css({cursor:"default"})}function u(t){return t.originalEvent.touches&&t.originalEvent.touches.length>0?t.originalEvent.touches[0]:t.originalEvent}function p(t){var e=t[0].getBoundingClientRect().left;return e=Math.max(e,0)}function g(t){var e=t[0].getBoundingClientRect().top;return e=Math.max(e,0)}function v(t,e,i,n){var o=u(t),r=function(t,e){return $(document).scrollLeft()+t.scrollLeft()-p(e)}(i,n),s=function(t,e){return $(document).scrollTop()+t.scrollTop()-g(e)-50}(i,n)+$("#div_"+e).scrollTop();return{x:b((0|o.clientX)-0+r),y:b((0|o.clientY)-0+s)}}function b(t){return Math.round(t)}this.SetOnDisplayChange=function(t){d=t},this._onEventStart=function(n,r,s,d){this.ShowSetting(!1),(i=this.CreateEle("path",{isdraw:"true",tp:"line",style:"fill:white;fill-opacity:0;stroke-linecap:round;","stroke-width":t,stroke:e})).setAttribute("d","M"+n+","+r),i.setAttribute("stroke-opacity",s?.4:1),o.append(i),a.push({x:n,y:r}),this.RecordLine(!0,d)},this._onEventMove=function(n,r,d,l){var h=i.getAttributeNode("d").nodeValue;h.length>8870?(a.push({x:n,y:r}),s.AddHistory(d,{id:i.getAttributeNode("id").nodeValue,color:e,width:t,isbrush:l}),s.AddPoints(d,a),a=new Array,this.RecordLine(!0,d),(i=this.CreateEle("path",{isdraw:"true",tp:"line",style:"fill:white;fill-opacity:0;stroke-linecap:round;","stroke-width":t,stroke:e})).setAttribute("d","M"+this.getLastNode(h)+" L"+n+","+r),i.setAttribute("stroke-opacity",l?.4:1),o.append(i)):i.setAttribute("d",h+" L"+n+","+r),a.push({x:n,y:r}),this.CheckRecordStep(n,r)&&this.RecordLine(!1,d)},this._onEventEnd=function(n,o,r,d){var l=i.getAttributeNode("d").nodeValue;return-1==l.indexOf("L")&&(a.push({x:n,y:o}),i.setAttribute("d",l+" L"+l.substr(l.indexOf("M")+1))),s.ClearRedo(r),s.AddHistory(r,{id:i.getAttributeNode("id").nodeValue,color:e,width:t,isbrush:d}),s.AddPoints(r,a),a=new Array,this.RecordLine(!0,r),!0},this.onStart=function(t,e){this.ele=this.CreateEle("rect",{isdraw:"true",tp:"board",style:"fill:blue;stroke:blue;stroke-width:1;fill-opacity:0.1;",width:0,height:0}),this.ele.setAttribute("x",t),this.ele.setAttribute("y",e),this.ele.setAttribute("sx",t),this.ele.setAttribute("sy",e),this.Append(),this.Record()},this.onMove=function(t,e){var i=parseInt(this.ele.getAttributeNode("sx").nodeValue),n=parseInt(this.ele.getAttributeNode("sy").nodeValue),o=t-i,r=e-n;return o>=0&&r>=0?(this.ele.setAttribute("width",o),this.ele.setAttribute("height",r)):o<0&&r<0?(this.ele.setAttribute("x",i+o),this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",-r)):o>=0&&r<0?(this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",o),this.ele.setAttribute("height",-r)):o<0&&r>=0&&(this.ele.setAttribute("x",i+o),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",r)),!0},this.onEnd=function(t,e){var i=this,n=(parseInt(this.ele.getAttributeNode("x").nodeValue),parseInt(this.ele.getAttributeNode("y").nodeValue),parseInt(this.ele.getAttributeNode("width").nodeValue)),o=parseInt(this.ele.getAttributeNode("height").nodeValue);if(n<20&&o<20)return $(this.ele).remove(),!1;var r=this.ele.getAttributeNode("id").nodeValue;$("#div_"+r);$("#"+r).bind(this.EVENTCLICK,function(t){i.Record(!0,1),i.EidtWhiteBoard(r,!0)});var s=this.Record(!0,1);if(this.onRecordHistory){s.mode=0;var a=new Array;a.push(this.RecordHistory_delete(s.id)),a.push(this.RecordHistory_delete("edit_"+s.id)),this.onRecordHistory(a,s)}return this.EidtWhiteBoard(r,!0),this.SetTool(""),!0},this.EidtWhiteBoard=function(t,e){var i=this,o=$("#edit_"+t);0==o.length&&(this.container.append(this.GetWBContainer(t)),o=$("#edit_"+t)),o.find(">div.boardhead").css({width:this.getContainerWidth(),top:g(this.container),left:p(this.container)}),o.show(),d&&d(!0),$("#WBTool_Del_"+t).unbind().bind(this.EVENTCLICK,function(e){0!=i.canEdit&&($("#svg_"+t).find(">path[isdraw='true'],>rect[isdraw='true'],>g[isdraw='true'],>circle[isdraw='true']").remove(),s.Clear(t),new Array,new Array,new Array,i.Record_clear("svg_"+t,!0),h(e))}),$("#WBTool_Close_"+t).unbind().bind(this.EVENTCLICK,function(t){0!=i.canEdit&&(i.ShowSetting(!1),o.hide(),d&&d(!1),i.Record(!0,2),i.SetTool(""))}),$("#WBTool_Undo_"+t).unbind().bind(this.EVENTCLICK,function(t){if(0!=i.canEdit){var e=$(this).attr("id").replace("WBTool_Undo_","");h(t);var n=s.Undo(e);if(!n||null==n)return!1;$("#"+n.id).remove(),i.Record_delete(n.id);var o=s.UndoPoints(e);return s.AddRedoPoints(e,o),s.AddRedoHistory(e,n),!1}}),$("#WBTool_Redo_"+t).unbind().bind(this.EVENTCLICK,function(t){if(0!=i.canEdit){h(t);var e=$(this).attr("id").replace("WBTool_Redo_",""),o=s.RedoPoints(e);if(null!=o&&0!=o.length){s.AddPoints(e,o);var a=s.RedoHistory(e);s.AddHistory(e,a);var d=n("path");d.setAttribute("id",a.id),d.setAttribute("isdraw","true"),d.setAttribute("tp","line"),d.setAttribute("style","fill:white;fill-opacity:0;stroke-linecap:round;"),d.setAttribute("stroke-width",a.width),d.setAttribute("stroke",a.color),d.setAttribute("d",function(t){var e="";if(1==t.length)e="M"+t[0].x+","+t[0].y+" L"+t[0].x+","+t[0].y;else for(var i=0,n=t.length;i<n;i++)0==i?e="M"+t[i].x+","+t[i].y:e+=" L"+t[i].x+","+t[i].y;return e}(o)),d.setAttribute("stroke-opacity",a.isbrush?.4:1),r("svg_"+e).appendChild(d),i.RecordLine(!0,e,d)}}}),$("#WBTool_Pen_"+t).unbind().bind(this.EVENTCLICK,function(t){if(0!=i.canEdit){var e=$(this).attr("id").replace("WBTool_Pen_","");c(e),$(this).hasClass("selected")?i.ShowSetting(!0):($(this).parent().find("span.selected").removeClass("selected"),$(this).addClass("selected"),i.DrawLine4Board(e,!1))}}),$("#WBTool_Brush_"+t).unbind().bind(this.EVENTCLICK,function(t){if(0!=i.canEdit){var e=$(this).attr("id").replace("WBTool_Brush_","");c(e),$(this).hasClass("selected")?i.ShowSetting(!0):($(this).parent().find("span.selected").removeClass("selected"),$(this).addClass("selected"),i.DrawLine4Board(e,!0))}}),$("#WBTool_Hand_"+t).unbind().bind(this.EVENTCLICK,function(t){if(0!=i.canEdit&&!$(this).hasClass("selected")){var e=$(this).attr("id").replace("WBTool_Hand_","");$(this).parent().find("span.selected").removeClass("selected"),$(this).addClass("selected");var n=0,o=0,r=!1;console.log("WBTool_Hand:"+e),$("#svg_"+e).css({cursor:"move"}),$("#svg_"+e).unbind().bind(i.EVENTSTART,function(t){var i=u(t);n=i.clientY;var s=$("#div_"+e);o=s.scrollTop(),r=!0}).bind(i.EVENTMOVE,function(t){if(r&&l(t)){var i=u(t).clientY-n,s=$("#div_"+e),a=o-i;a=Math.max(a,0),s.scrollTop(a)}else r=!1}).bind(i.EVENTEND,function(t){r=!1})}});var a=0;$("#div_"+t).unbind().bind("scroll",function(e){if(0!=i.canEdit){var n=r("div_"+t).scrollTop,o=Math.abs(n-a);r("div_"+t).scrollHeight-r("div_"+t).scrollTop-r("div_"+t).clientHeight<62&&($("#svg_"+t).height($("#svg_"+t).height()+.5*$("#div_"+t).height()),i.Record_resize("svg_"+t,1)),o<30||(a=n,i.Record_scroll("div_"+t))}}),1==this.canEdit?($("#WBTool_Pen_"+t).parent().find("span.selected").removeClass("selected"),$("#WBTool_Pen_"+t).addClass("selected"),$("#svg_"+t).css({cursor:"default"}),$("#svg_"+t).unbind(),this.DrawLine4Board(t)):$("#WBTool_Hand_"+t).parent().find("span.selected").removeClass("selected")},this.DrawLine4Board=function(t,e){var i=!1,n=this;o=$("#svg_"+t),$("#svg_"+t).unbind().bind(n.EVENTSTART,function(o){if(l(o)){i=!0;var r=v(o,t,n.main,n.container);return n._onEventStart(r.x,r.y,e,t),o.originalEvent.preventDefault(),o.originalEvent.stopPropagation(),!1}}).bind(n.EVENTMOVE,function(o){if(l(o)&&0!=i){var r=v(o,t,n.main,n.container);return n._onEventMove(r.x,r.y,t,e),o.originalEvent.preventDefault(),o.originalEvent.stopPropagation(),!1}}).bind(n.EVENTEND,function(o){if(0!=i){var r=v(o,t,n.main,n.container);return i=!1,n._onEventEnd(r.x,r.y,t,e)?(o.originalEvent.preventDefault(),o.originalEvent.stopPropagation(),!1):void console.log("event end return")}})},this.GetWBContainer=function(t){this.getViewWidth(),this.getViewHeight();var e=this.getContainerHeight(),i="<div id='edit_"+t+"' class='boardcontainer' tabindex='11' style='position: absolute;box-sizing:border-box;  z-index:103;top:0px; left:0px;width:100%;height:100%;";return i+="background-color:white; border:1px solid #d3d3d3; border-radius:10px; box-shadow: 5px 5px 3px #d3d3d3;display:none;'>",i+="<div class='boardhead' style='height:50px;border-bottom:1px solid #d3d3d3;border-left:1px solid #d3d3d3;border-right:1px solid #d3d3d3;width:100%; z-index:102;background-color:white;position: fixed;display: inline-block;top: 0px;left:0px;'><div style='float:left;height:100%;line-height:50px;padding-top:3px;'><span id='WBTool_Hand_"+t+"' class='WBTool_btn'><img width='20px;' title='Hand' src='"+this.ImagePath+"wb_hand.png' /></span>",i+="<span id='WBTool_Pen_"+t+"' class='WBTool_btn selected'><img width='20px;' title='Pen' src='"+this.ImagePath+"wb_pen.png' /></span><span id='WBTool_Brush_"+t+"' class='WBTool_btn'><img width='20px;' title='Brush' src='"+this.ImagePath+"wb_brush.png' /></span>",i+="<span id='WBTool_Del_"+t+"' class='WBTool_btn'><img width='20px;' title='Delete' src='"+this.ImagePath+"wb_delete.png' /></span>",i+="<span id='WBTool_Undo_"+t+"' class='WBTool_btn'><img width='20px;' title='Undo' src='"+this.ImagePath+"wb_undo.png' /></span><span id='WBTool_Redo_"+t+"' class='WBTool_btn'><img width='20px;' title='Redo' src='"+this.ImagePath+"wb_redo.png' /></span>",i+="</div>",i+="<div style='float:left;height:100%;line-height:50px;padding:2px 0px 0px 10px;'><span id='WBTool_Close_"+t+"' style='cursor:pointer; padding-right:10px;'><img width='20px;' title='Close' src='"+this.ImagePath+"wb_close.png' /></span></div></div><div style='height: 50px;'></div>",i+="<div id='div_"+t+"' style='height:calc(100% - 50px);width:100%;overflow:hidden;position:relative;padding-top:0px;'>",i+="<svg id='svg_"+t+"' width='100%' height='"+3*e+"px' version='1.1' xmlns='http://www.w3.org/2000/svg' xlink='http://www.w3.org/1999/xlink'></svg>",i+="</div></div>"},this.Record=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this.CreateRecordBaseInfo(27);return t&&(i.save=1),i.mode=e,this.ele.getAttributeNode("x")&&(i.x=parseInt(this.ele.getAttributeNode("x").nodeValue)),this.ele.getAttributeNode("y")&&(i.y=parseInt(this.ele.getAttributeNode("y").nodeValue)),this.ele.getAttributeNode("width")&&(i.width=parseInt(this.ele.getAttributeNode("width").nodeValue)),this.ele.getAttributeNode("height")&&(i.height=parseInt(this.ele.getAttributeNode("height").nodeValue)),this.RecordHandle(i),i},this.RecordLine=function(t,e,n){n=n||i;var o=this.CreateRecordBaseInfo(21,{d:"d",w:"stroke-width",color:"stroke",op:"stroke-opacity"},n);return t&&(o.save=1),o.tar="div_"+e,this.RecordHandle(o),o},this.ShowSetting=function(i){this.ShowColorSizeSetting(t,e,i,!0)},this.AfterSelectSizeSetting=function(e){t=e},this.AfterSelectColorSetting=function(t){e=t}}function L(){O.call(this,"ToolVideo");var t=null,e=null,i=this;this.SetOnSelectVideo=function(e){t=e},this.SetOnVideoPlay=function(t){e=t},this.onClick=function(t,e){var i=o();this.VideoTagAction(i,t,e),this.VideoTagEdit(i,t,e),this.VideoTagSelect(i);var n=this.Record(!0);if(this.onRecordHistory){var s=new Array;s.push(this.RecordHistory_delete(n.id)),s.push(this.RecordHistory_delete("edit_"+n.id)),this.onRecordHistory(s,n)}return this.SetTool(""),this.ele=r(i),!0},this.Delete=function(){if(this.SetActiveTool(null),!this.ele)return!1;var t=this.Record(!0,!1);if(this.onRecordHistory){var e=new Array;e.push(this.RecordHistory_delete(t.id)),e.push(this.RecordHistory_delete("edit_"+t.id)),this.onRecordHistory(t,e)}var i=this.ele.id;return this.Record_delete(i),this.Record_delete("edit_"+i),$("#"+i).remove(),$("#edit_"+i).remove(),!0},this.VideoTagAction=function(t,e,n,o){var r=$("#"+t);if(0==r.length){var s='<div id="'+t+'" class="live-video-tool-container selected" style="left:'+(e-50)+"px;top:"+(n-50)+'px;">';s+='  <div style= "position:relative;width:100%;height:100%;padding:0px;margin:0px;" >',s+='    <div class="live-video-tool-icon">',s+='      <span><img src="'+this.ImagePath+'icon-video.png" /></span>',s+="    </div>",s+='    <div class="live-video-tool-edit">',s+='      <span><img src="'+this.ImagePath+'icon-edit.png" /></span>',s+="    </div>",s+='    <div class="live-video-tool-play">',s+='     <span><img src="'+this.ImagePath+'icon-play.png" /></span>',s+='    </div><input type="hidden"></input>',s+="    </div >",s+="  </div>",this.container.append(s),r=$("#"+t)}else r.show();this.SetEle(r[0]),o?$("#"+t).find("INPUT").val(o):$("#"+t).find("INPUT").val(""),r.find("div.live-video-tool-icon").unbind().bind(this.EVENTCLICK,function(t){r.hasClass("selected")?r.removeClass("selected"):r.addClass("selected")}),r.find("div.live-video-tool-play").unbind().bind(this.EVENTCLICK,function(e){var n=$("#"+t).find("INPUT").val();if(null!=n&&""!=n){var o=JSON.parse(n);i.VideoTagPlay(o.id)}else alert("No video to play!")}),r.find("div.live-video-tool-edit").unbind().bind(this.EVENTCLICK,function(o){i.VideoTagEdit(t,e,n)})},this.VideoTagEdit=function(t,e,n){var o=$("#edit_"+t);if(0==o.length){var r=e+55;e+55+300>this.container.width()&&(r=e-55-300);var s='<div id="edit_'+t+'" class="live-video-tool-editvideo" style="left:'+r+"px;top:"+(n-55)+'px;">';s+='  <div class="live-video-tool-edit-top">',s+='    <span style="font-weight:bold;">Insert Video/Audio<input class="live-video-tool-info" type="hidden"></input></span>',s+='    <span class="live-video-tool-edit-del"><img src="'+this.ImagePath+'icon-delete.png" /></span>',s+="    </div>",s+='  <div style="height:120px; text-align:left;">',s+='    <div class="live-video-tool-edit-listcontainer">',s+="       <ul>",s+='         <li style="width:50px">Name:</li>',s+='         <li class="live-video-tool-edit-name" style="width:230px;text-overflow: ellipsis;overflow: hidden;height:21px;"></li>',s+="       </ul>",s+='       <ul style="clear:both;">',s+='         <li style="width:50px">Size:</li>',s+='         <li class="live-video-tool-edit-length" style="width:230px;height:21px;"></li>',s+="       </ul>",s+='       <ul style="clear:both;">',s+='         <li style="width:50px">Time:</li>',s+='         <li class="live-video-tool-edit-time" style="width:230px;height:21px;"></li>',s+="       </ul>",s+="     </div>",s+='     <div class="live-video-tool-edit-selectcontainer">',s+='      <span class="live-video-tool-edit-selectvideo">Select Video/Audio...</span>',s+="    </div>",s+='    <div class="live-video-tool-edit-changecontainer" style="display:none;">',s+='      <span><img src="'+this.ImagePath+'icon-change.png" /></span>',s+='       <span style="cursor:pointer;">Change Video/Audio</span>',s+="     </div>",s+="   </div>",s+='   <div style="height:26px; text-align:center;display:none;">',s+='   <span class="live-video-tool-edit-recording"><label><input onclick="_cancelBubble(event);" type="checkbox"/>Enable voice recording</label></span>',s+="   </div>",s+='   <div style="height:36px; text-align:center;display:none;">',s+='   <span class="live-video-tool-edit-sync">Sync</span>',s+="   </div>",s+='   <div class="live-video-tool-edit-bottom">',s+='    <span class="live-video-tool-edit-cancel">Cancel</span>',s+='    <span class="live-video-tool-edit-save">Save</span>',s+="  </div>",s+="  </div>",this.container.append(s),o=$("#edit_"+t)}else o.show();var a=$("#"+t).find("INPUT").val();try{if(null!=a&&""!=a){var d=JSON.parse(a);o.find("INPUT.live-video-tool-info").val(JSON.stringify(d)),o.find("li.live-video-tool-edit-name").html(d.name),o.find("li.live-video-tool-edit-length").html(d.size),o.find("li.live-video-tool-edit-time").html(d.time),o.find("div.live-video-tool-edit-selectcontainer").hide(),o.find("div.live-video-tool-edit-changecontainer").show()}}catch(t){}o.find("div.live-video-tool-edit-selectcontainer").unbind().bind(this.EVENTCLICK,function(e){i.VideoTagSelect(t)}),o.find("div.live-video-tool-edit-changecontainer").unbind().bind(this.EVENTCLICK,function(e){i.VideoTagSelect(t)}),o.find("span.live-video-tool-edit-del").unbind().bind(this.EVENTCLICK,function(e){o.remove(),$("#"+t).remove(),i.Record_delete(t,1),i.SetActiveTool(null)}),o.find("span.live-video-tool-edit-save").unbind().bind(this.EVENTCLICK,function(e){$("#"+t).find("INPUT").val(o.find("INPUT.live-video-tool-info").val()),o.remove(),i.Record(!0),i.SetActiveTool(null)}),o.find("span.live-video-tool-edit-cancel").unbind().bind(this.EVENTCLICK,function(t){o.remove(),i.SetActiveTool(null)}),this.SetActiveTool(this)},this.VideoTagSelect=function(e){t&&t(e,this.VideoTagAfterSelect)},this.VideoTagAfterSelect=function(t,e){var n=$("#edit_"+t);if(null==e)""==n.find("INPUT.live-video-tool-info").val()&&$("#"+t).remove(),n.remove(),i.SetActiveTool(null);else{var o=i.Record(!0,!1),r=new Object;r.id=e.ItemID,r.name=e.Title,r.time=e.VideoDuration,r.size=e.VideoSize,r.type=e.FileType,n.find("INPUT.live-video-tool-info").val(JSON.stringify(r)),n.find("li.live-video-tool-edit-name").html(r.name),n.find("li.live-video-tool-edit-length").html(r.size),n.find("li.live-video-tool-edit-time").html(r.time),n.find("div.live-video-tool-edit-selectcontainer").hide(),n.find("div.live-video-tool-edit-changecontainer").show(),$("#"+t).find("INPUT").val(JSON.stringify(r)),n.remove();var s=i.Record(!0);i.onRecordHistory(o,s)}},this.VideoTagPlay=function(t){e&&e(t)},this.Record=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.CreateRecordBaseInfo(33);return t&&(i.save=1),i.Left=parseInt(this.ele.style.left.replace("px",""))+50,i.Top=parseInt(this.ele.style.top.replace("px",""))+50,""!=$(this.ele).find("INPUT").val()&&(i.Info=JSON.parse($(this.ele).find("INPUT").val())),e&&this.RecordHandle(i),i}}function M(){O.call(this,"ToolClear"),this.Record=function(t,e){var i=this.CreateRecordBaseInfo(103);return t&&(i.save=1),i.id=e,this.RecordHandle(i),i},this.ClearPath=function(t){if(t&&t.length>0){for(var e=new Array,i=0;i<t.length;i++){var n=this.Record_delete(t[i],1);e.push(n),$("#"+t[i]).remove()}return e}var o=!1,r=this.target.find(">path[isdraw='true'],>g[isdraw='true'],>circle[isdraw='true']");r.length>0&&(r.remove(),o=!0),this.target.find(">rect[isdraw='true']").each(function(t){o=!0,"board"==$(this).attr("tp")&&$("#edit_"+$(this).attr("id")).remove(),$(this).remove()});var s=this.container.find("div.live-video-tool-container");return s.length>0&&(s.remove(),o=!0),o?this.Record(!0,"svg"+this.GetFixedPageNumber(this.pagenumber)):null}}function D(){O.call(this,"ToolSelect");var t=null,e=!1;this.SetOnSelectEle=function(e){t=e},this.onStart=function(t,i){return 0==this.deviceType&&(e=!1,this.target.find("rect[tp='select']").remove(),this.ele=this.CreateEle("rect",{isdraw:"true",tp:"select",style:"stroke:blue;stroke-dasharray:5;stroke-width:1;fill-opacity:0;",width:0,height:0}),this.ele.setAttribute("x",t),this.ele.setAttribute("y",i),this.ele.setAttribute("sx",t),this.ele.setAttribute("sy",i),this.Append(),!1)},this.onMove=function(t,e){if(0!=this.deviceType)return!1;if(!this.ele)return!1;var i=parseInt(this.ele.getAttributeNode("sx").nodeValue),n=parseInt(this.ele.getAttributeNode("sy").nodeValue),o=t-i,r=e-n;return o>=0&&r>=0?(this.ele.setAttribute("width",o),this.ele.setAttribute("height",r)):o<0&&r<0?(this.ele.setAttribute("x",i+o),this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",-r)):o>=0&&r<0?(this.ele.setAttribute("y",n+r),this.ele.setAttribute("width",o),this.ele.setAttribute("height",-r)):o<0&&r>=0&&(this.ele.setAttribute("x",i+o),this.ele.setAttribute("width",-o),this.ele.setAttribute("height",r)),!1},this.onEnd=function(t,i){if(0!=this.deviceType)return!1;if(!this.ele)return!1;t=parseInt(this.ele.getAttributeNode("x").nodeValue),i=parseInt(this.ele.getAttributeNode("y").nodeValue);var n=parseInt(this.ele.getAttributeNode("width").nodeValue),o=parseInt(this.ele.getAttributeNode("height").nodeValue);return e=n+o>8,$(this.ele).remove(),this.SelectEle(t,i,n,o),e},this.onClick=function(t,i){return e},this.SelectEleQuick=function(e,i,n,o){var r=this;this.target.find(">path[isdraw='true']").each(function(s){var a=$(this).attr("tp");if(a&&("line"==a||"sline"==a||"brush"==a)){var d=$(this)[0].getBoundingClientRect();r.isInRect(e,i,n,o,d)&&t&&t($(this).attr("id"),1)}})},this.SelectEle=function(e,i,n,o){var r=this;this.target.find(">path[isdraw='true']").each(function(s){var a=$(this).attr("tp");if(a&&("line"==a||"sline"==a||"brush"==a)){var d,l,h,c,u,p=$(this)[0].getBoundingClientRect();if(p.y+=$(document).scrollTop()+r.main.scrollTop(),p.x+=$(document).scrollLeft()+r.main.scrollLeft(),r.isInRect(e,i,n,o,p))for(var g=$(this).attr("d").split("L"),f=-1,v=-1,b=0,x=g.length;b<x;b++){var y=g[b].split(","),w=parseFloat(y[0].replace("M","").replace(" ","")),C=parseFloat(y[1].replace("M","").replace(" ",""));if(b>0){var m=(d=f,l=v,h=w,c=C,u=void 0,(u=new Object).x=Math.min(d,h),u.y=Math.min(l,c),u.width=Math.abs(d-h),u.height=Math.abs(l-c),u);if(r.isInRect(e,i,n,o,m)){t&&t($(this).attr("id"),1);break}}f=w,v=C}}})},this.Record=function(t,e){var i=this.CreateRecordBaseInfo(104);return t&&(i.save=1),i.id=e,this.RecordHandle(i),i}}function G(){var t=1,e=1,i="",n=0,o=10,s=0;this.main=null,this.pagenumber=1,this.VerticalInMiddle=!0,this.SetMain=function(t){this.main=t},this.SetPageNumber=function(e){this.pagenumber=e,t=1},this.SetParamter=function(t,e){this.main=t,this.pagenumber=e},this.SetSizeMode=function(t){n=t},this.SetSizeDiff=function(t){o=t},this.SetDeviceType=function(t){s=t},this.SetVerticalInMiddle=function(t){this.VerticalInMiddle=t},this.getViewHeight=function(){return this.main.height()},this.getViewWidth=function(){return this.main.width()},this.GetPdfPageUrl=function(t,e){return t.replace(/\<\d+\>/gi,e)},this.GetPdfCount=function(t){var e=t.match(/\<\d+\>/gi);return e&&0!=e.length?parseInt(e[0].replace(/\<|\>/gi,"")):1},this.AdjustURL=function(t){return 0!=s?t:screen.width<=1024?t:screen.width>=1920?t.replace(">.",">_4K."):t.replace(">.",">_2K.")},this.ShowPDF=function(n,o,r,s){this.pagenumber=o,n=this.AdjustURL(n),e=this.GetPdfCount(n),i=n,t=1,this.main?(this.main.empty(),this.ShowImagePageEx(o,function(){r&&r(!0,e)},!1,this.GetPdfPageUrl(n,o),!1,s)):r&&r(!1,e)},this.ShowPDFPage=function(t,e,n,o){this.pagenumber=t,this.ShowImagePageEx(t,function(t){e&&e(t)},n,this.GetPdfPageUrl(i,t),o)},this.ShowImagePageEx=function(e,i,s,a,d,l){var h=this;$("#pageContainer"+e).length>0&&$("#pageContainer"+e).remove();var c=document.createElement("div");c.id="pageContainer"+e,c.className="pageContainer",void 0!==s&&1==s?c.style.display="none":(s=!1,t=1,this.pagenumber=e),0==n?(c.style.width=this.getViewWidth()-o+"px",c.style.height=this.getViewHeight()+"px",c.setAttribute("CW",this.getViewWidth()-o),c.innerHTML="<div id='canvas"+e+"' style='position:absolute;width:100%;top:0px;'><img id='img_"+e+"' style='width:100%;'></div><svg id='svg"+e+"' style='position:relative;top:0px;left:0px;'  width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg' xlink='http://www.w3.org/1999/xlink'></svg>"):1==n?(c.style.width=this.getViewWidth()+"px",c.style.height=this.getViewHeight()+"px",c.setAttribute("CH",this.getViewHeight()),c.innerHTML="<div id='canvas"+e+"' style='position:absolute;height:100%;top:0px;'><img id='img_"+e+"' style='height:100%;'></div><svg id='svg"+e+"' style='position:relative;top:0px;left:0px;'  width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg' xlink='http://www.w3.org/1999/xlink'></svg>"):2==n&&(c.style.width=this.getViewWidth()-o+"px",c.style.height=this.getViewHeight()+"px",c.setAttribute("CW",this.getViewWidth()-o),c.setAttribute("CH",this.getViewHeight()),c.innerHTML="<div id='canvas"+e+"' style='position:absolute;width:100%;top:0px;'><img id='img_"+e+"' style='width:100%;height:100%;'></div><svg id='svg"+e+"' style='position:relative;top:0px;left:0px;'  width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg' xlink='http://www.w3.org/1999/xlink'></svg>"),this.main.append(c);var u=r("img_"+e);u&&(u.onload=function(){s?0==n?$("#"+$(u).attr("id").replace("img_","pageContainer")).height(h.getViewWidth()*u.height/u.width):1==n&&$("#"+$(u).attr("id").replace("img_","pageContainer")).width(h.getViewHeight()*u.width/u.height):(0==n?$("#"+$(u).attr("id").replace("img_","pageContainer")).height(u.height):1==n&&$("#"+$(u).attr("id").replace("img_","pageContainer")).width(u.width),h.CheckZoom()),l&&l()},u.onerror=function(t){if(this.src&&this.src.indexOf("_4K.")>0)this.src=this.src.replace("_4K.","_2K.");else if(this.src&&this.src.indexOf("_2K.")>0)this.src=this.src.replace("_2K.",".");else if($(this).attr("retry")){var e=parseInt($(this).attr("retry"));if(e>=5)return;$(this).attr("retry",e+1),setTimeout(function(){u.src=a},5e3+2e3*e)}else $(this).attr("retry","1"),setTimeout(function(){u.src=a},5e3)},u.src=a),this.CheckZoom(),i&&i(!0)},this.ZoomIn=function(){var e=t;return e=(1.1*e).toFixed(2),e=Math.ceil(10*e)/10,e=Math.min(5,e),t=e,this.SizeChanged(e),e},this.ZoomOut=function(){var e=t;return e=(e/1.1).toFixed(2),e=Math.floor(10*e)/10,e=Math.max(.2,e),t=e,this.SizeChanged(e),e},this.SizeChanged=function(e){if(t=e,this.main){if(0==n){var i=this.getViewWidth()*e;1==e&&(i-=10),$("#pageContainer"+this.pagenumber).css({width:i}).attr("CW",i),$("#canvas"+this.pagenumber).width(i),$("#pageContainer"+this.pagenumber).height($("#img_"+this.pagenumber).height())}else if(1==n){i=this.getViewHeight()*e;1==e&&(i-=10),$("#pageContainer"+this.pagenumber).css({height:i}).attr("CH",i),$("#canvas"+this.pagenumber).height(i),$("#pageContainer"+this.pagenumber).width($("#img_"+this.pagenumber).width())}this.CheckZoom()}},this.CheckZoom=function(){if(this.VerticalInMiddle){var t=this.main.height(),e=$("#pageContainer"+this.pagenumber).height();if(e<t){var i=(t-e)/2;i>10&&i<=20?i-=5:i>20&&i<=50?i-=10:i>50&&(i-=20),$("#pageContainer"+this.pagenumber).css("top",i+"px"),$("#pageContainer"+this.pagenumber).find("div.boardhead").css("top",(t-e)/2+"px")}else $("#pageContainer"+this.pagenumber).css("top",""),$("#pageContainer"+this.pagenumber).find("div.boardhead").css("top","")}},this.GetScale=function(){return t}}Object.setPrototypeOf(b.prototype,v.prototype),Object.setPrototypeOf(x.prototype,v.prototype),Object.setPrototypeOf(y.prototype,v.prototype),Object.setPrototypeOf(w.prototype,v.prototype),Object.setPrototypeOf(C.prototype,v.prototype),Object.setPrototypeOf(m.prototype,v.prototype),Object.setPrototypeOf(T.prototype,v.prototype),Object.setPrototypeOf(A.prototype,v.prototype),Object.setPrototypeOf(S.prototype,v.prototype),Object.setPrototypeOf(function(t){v.call(this,"PlayChangePage",t),this.Play=function(){console.log(this.name+":Play not done")}}.prototype,v.prototype),Object.setPrototypeOf(W.prototype,v.prototype),Object.setPrototypeOf(R.prototype,v.prototype),Object.setPrototypeOf(_.prototype,v.prototype),Object.setPrototypeOf(P.prototype,v.prototype),Object.setPrototypeOf(E.prototype,v.prototype),Object.setPrototypeOf(I.prototype,v.prototype),Object.setPrototypeOf(z.prototype,v.prototype),Object.setPrototypeOf(V.prototype,O.prototype),Object.setPrototypeOf(V.prototype,O.prototype),Object.setPrototypeOf(N.prototype,O.prototype),Object.setPrototypeOf(H.prototype,O.prototype),Object.setPrototypeOf(B.prototype,O.prototype),Object.setPrototypeOf(F.prototype,O.prototype),Object.setPrototypeOf(L.prototype,O.prototype),Object.setPrototypeOf(M.prototype,O.prototype),Object.setPrototypeOf(D.prototype,O.prototype),e.default=function(){var t=this,e=null,i="",n=null,o=null,s=null,d=null,l=null,h=null,c=null,u=null,p=null,g=null,f=0,v=1,O="",j="pointerdown",U="pointermove",K="mouseup pointerup",Z=null,J=null,Y=!1,X=!1,q=0,Q=new G,tt=!0,et=!1,it=new Array,nt=null,ot=null,rt=[0,0],st=!1,at=0,dt=new Array,lt=new Array,ht=new Array;function ct(t){if(!o)return!1;var e=t.originalEvent;if(e.touches&&e.touches.length>1)return!1;if(void 0!==e.isPrimary&&0==e.isPrimary)return!1;var i=$(e.target);return!("media-header"==i.attr("id")||"media-panel-actions"==i.attr("id")||"svg"!=i[0].tagName.toLowerCase()&&"svg"!=i.parent()[0].tagName.toLowerCase()||e.pointerType&&"mouse"==e.pointerType&&1!=e.button&&0!=e.button&&-1!=e.button)}function ut(t){return t.originalEvent.touches&&t.originalEvent.touches.length>0?t.originalEvent.touches[0]:t.originalEvent}function pt(){return $(document).scrollTop()-s[0].getBoundingClientRect().top}function gt(){return $(document).scrollLeft()-s[0].getBoundingClientRect().left}function ft(t){var e=ut(t),i=gt(),n=pt();return{x:vt((0|e.clientX)-0+i),y:vt((0|e.clientY)-0+n)}}function vt(t){return Math.round(t)}function bt(t,e){return Z.onMove(t,e)}function xt(){X=!1,n&&n.unbind(j+" "+K)}function yt(){n&&(X=!0,n.unbind(j+" "+K).bind(j,function(t){if(ct(t)){st=!0;var e,i,n=ft(t);return e=n.x,i=n.y,Z.ShowSetting(!1),Z.onStart(e,i)?(t.originalEvent.preventDefault(),t.originalEvent.stopPropagation(),!1):void 0}}).bind(K,function(t){if(0!=st&&ct(t)){var e,i,n=ft(t);return st=!1,e=n.x,i=n.y,Z.onEnd(e,i)?(t.originalEvent.preventDefault(),t.originalEvent.stopPropagation(),!1):void 0}}).bind(U,function(t){if(ct(t)&&0!=st){var e=ft(t);return bt(e.x,e.y)?(t.originalEvent.preventDefault(),t.originalEvent.stopPropagation(),!1):void 0}}))}function wt(t){var i=ft(t);if(r=i.x,a=i.y,Z&&Z.onClick(r,a))return t.originalEvent.preventDefault(),t.originalEvent.stopPropagation(),!1;var r,a,d=$(t.originalEvent.target);if(""!=e||!tt||"true"!=d.attr("isdraw")||"line"!=d.attr("tp")&&"sline"!=d.attr("tp")&&"brush"!=d.attr("tp"))""==e&&tt&&!d.is("path,rect")&&St();else{var l=d.attr("class");l&&""!=l?(d.removeAttr("class"),At(d.attr("id")),Ot(d.attr("id"),0)):mt(d.attr("id"))}!function(t){if(Y){var e,i=$(t.originalEvent.target),r=ft(t),a=new Object;a.type=35,a.poz=[r.x,r.y],"svg"==i[0].tagName.toLowerCase()?0==i.attr("id").indexOf("svg_")?a.bd=1:a.bd=0:"svg"==i.parent()[0].tagName.toLowerCase()&&0==i.parent().attr("id").indexOf("svg_")?a.bd=1:a.bd=0,a.page=f,a.VW=Et(),a.ST=0|n.scrollTop(),a.SL=0|n.scrollLeft(),$t(a),(e=new S(a)).SetParamter(o,s,n,f,q),e.SetCanEdit(tt),e.Play()}}(t)}function Ct(t){var e=null;switch(t){case"ToolPen":e=new V;break;case"ToolLine":e=new k;break;case"ToolBrush":e=new N;break;case"ToolText":e=new H;break;case"ToolNote":e=new B;break;case"ToolBoard":e=new F;break;case"ToolVideo":e=new L;break;case"ToolClear":e=new M;break;case"":e=new D;break;default:e=null}return e}function mt(t,e){var i=$("#"+t),n=r(t).getBBox();n.width+n.height<10?i.attr("class","WB_SelectPathSmall"):i.attr("class","WB_SelectPath"),Tt(t),Ot(t,1)}function Tt(t){-1==a(dt,t)&&dt.push(t)}function At(t){var e=a(dt,t);e>-1&&dt.splice(e,1)}function St(){for(var t=0,e=dt.length;t<e;t++)$("#"+dt[t]).removeAttr("class"),Ot(dt[t],0);dt=[]}function Wt(){lt=[],ht=[]}function Rt(){return s.width()}function _t(){return s.height()}function Pt(){return n.height()}function Et(){return n.width()}function $t(t){Y&&d&&d(t)}function It(){if(s&&n){var t=new Object;t.type=32,t.page=f,t.CW=Rt(),t.CH=_t(),t.VW=Et(),t.VH=Pt(),t.ST=0|n.scrollTop(),t.SL=0|n.scrollLeft(),$t(t)}}function zt(t){var e=new Object;e.type=2,e.page=t,$t(e)}function Ot(t,e){var i=new Object;i.type=104,i.id=t,i.page=f,i.stat=e,$t(i)}function Vt(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(Y){var i,n,o,r=ft(t);et=!0,nt&&(clearTimeout(nt),nt=null),ot&&(clearTimeout(ot),ot=null),1==e?(it.push([r.x,r.y]),kt(10,!0,0)):(i=r.x,n=r.y,(o=Math.abs(i-rt[0])+Math.abs(n-rt[1])>=60)&&(rt=[i,n]),o&&(it.push([r.x,r.y]),kt(10,!0,0)))}}function kt(t,e,i){if(!(it.length<1)){var o=new Object;if(o.type=34,o.show=1,o.sleep=t,o.bd=i,1==e){var r=it.splice(0,it.length);r.length>1&&r.splice(0,r.length-1),o.poz=r,o.delay=1}else o.delay=1,o.poz=it.splice(0,it.length);o.page=f,o.VW=Et(),o.ST=0|n.scrollTop(),o.SL=0|n.scrollLeft(),$t(o)}}function Nt(t){Y&&et&&(ot&&(clearTimeout(ot),ot=null),ot=setTimeout(function(){et=!1;var t=new Object;t.type=34,t.show=0,t.page=f,$t(t)},50))}this.ResumeTool=function(){Z&&(yt(),Z.SetParamter(this.OnReocrd,o,s,n,f,q,this.OnSetTool,this.OnSetActiveTool,this.OnRecordHistory),Z.SetCanEdit(tt))},this.OnSetTool=function(e){l&&l(e),t.SetDrawTool(e)},this.OnSetActiveTool=function(t){J=t},this.OnRecordHistory=function(t,e){0==lt.length&&g&&g(1,ht.length>0?1:0),lt.push({Undo:t,Redo:e})},this.OnSelectEle=function(t,e){0==e?($("#"+t).removeAttr("class"),At(t),Ot(t,0)):mt(t)},this.OnReocrd=function(t){$t(t)},this.OnEditText=function(e,i){var r=new H;r.SetParamter(t.OnReocrd,o,s,n,f,q,t.OnSetTool,t.OnSetActiveTool,t.OnRecordHistory),r.SetEle(e[0]),r.SetCanEdit(tt),r.EidtText(e,i),t.OnSetTool("")},this.OnEditNote=function(e,i){var a=new B;a.SetParamter(t.OnReocrd,o,s,n,f,q,t.OnSetTool,t.OnSetActiveTool,t.OnRecordHistory),a.SetEle(r(e)),a.SetCanEdit(tt),a.EidtAnnotation($("#g_"+e),i),t.OnSetTool("")},this.OnEditVideo=function(e,i,r,a){var d=new L;d.SetParamter(t.OnReocrd,o,s,n,f,q,t.OnSetTool,t.OnSetActiveTool,t.OnRecordHistory),d.SetCanEdit(tt),d.VideoTagAction(e,i,r,a),d.SetOnSelectVideo(c),d.SetOnVideoPlay(p)},this.OnEditBoard=function(e,i,r){var a=new F;a.SetParamter(t.OnReocrd,o,s,n,f,q,t.OnSetTool,t.OnSetActiveTool,t.OnRecordHistory),a.SetCanEdit(tt),a.SetEle(e),a.SetOnDisplayChange(u),a.EidtWhiteBoard(i,r),t.OnSetTool("")},this.OnRecordNote=function(e){var i=new B;i.SetParamter(t.OnReocrd,o,s,n,f,q,t.OnSetTool,t.OnSetActiveTool,t.OnRecordHistory),i.SetEle(e),i.Record(!0)},this.OnRecordBoard=function(e,i,r){var a=new F;a.SetParamter(t.OnReocrd,o,s,n,f,q,t.OnSetTool,t.OnSetActiveTool,t.OnRecordHistory),a.SetEle(e),a.Record(i,r)},this.OnZoomChange=function(e,i){var n=t.GetPageInfo();t.Clear(),e=Q.SizeChanged(e);var o=!0,r=!1,s=void 0;try{for(var a,d=n[Symbol.iterator]();!(o=(a=d.next()).done);o=!0){var l=a.value;t.Play(l)}}catch(t){r=!0,s=t}finally{try{!o&&d.return&&d.return()}finally{if(r)throw s}}i&&i()},this.SetRecord=function(t){Y=t},this.SetDeviceType=function(t){q=t,0!=t&&(j="touchstart",U="touchmove",K="touchend",Q.SetSizeDiff(0),Q.SetDeviceType(t))},this.SetSizeMode=function(t){at=t,Q.SetSizeMode(t)},this.SetVerticalInMiddle=function(t){Q.SetVerticalInMiddle(t)},this.ShowSetting=function(t){Z.ShowSetting(t)},this.SetDrawTool=function(t,r){if(e=t,""!=t&&(i=t),Z=Ct(t)){if(Z.SetParamter(this.OnReocrd,o,s,n,f,q,this.OnSetTool,this.OnSetActiveTool,this.OnRecordHistory),Z.SetCanEdit(tt),"ToolVideo"==t?(Z.SetOnSelectVideo(c),Z.SetOnVideoPlay(p)):"ToolBoard"==t?Z.SetOnDisplayChange(u):""==t&&Z.SetOnSelectEle(this.OnSelectEle),X||yt(),"ToolClear"==t){if(dt.length>0){var a=this.GetPageInfo($("#"+dt.join(",#")));null!=(d=Z.ClearPath(dt))&&this.OnRecordHistory(a,d),dt=[]}else if(J&&1==J.Delete())J=null;else{if(!confirm("Do you want to clear all items?"))return void this.OnSetTool("");var d;a=this.GetPageInfo(),null!=(d=Z.ClearPath())&&this.OnRecordHistory(a,d)}this.OnSetTool("")}}else xt()},this.Clear=function(){o&&(o.find(">path[isdraw='true'],>g[isdraw='true'],>circle[isdraw='true']").remove(),o.find(">rect[isdraw='true']").each(function(t){"board"==$(this).attr("tp")&&$("#edit_"+$(this).attr("id")).remove(),$(this).remove()})),s&&(s.find("div.live-video-tool-container").remove(),s.find("div.liveMouseClick,div.liveMouse").remove())},this.Init=function(t,e,i,r){n=e,o=t,s=i,f=r,Q.SetMain(e)},this.OnReceviceData=function(t){d=t},this.OnToolReset=function(t){l=t},this.SwitchLastTool=function(){""==i?e&&""!=e&&(this.SetDrawTool(e),l&&l(e)):e&&""!=e?(this.SetDrawTool(""),l&&l("")):(this.SetDrawTool(i),l&&l(i))},this.Play=function(t){"string"==typeof t&&(t=JSON.parse(t));var e=null;switch(t.type){case 1:break;case 2:return void function(t){if(!(t.page>v||t.page<1)){var e=t.page;Q.ShowPDF(O,e,function(t,i){f=e,o=$("#svg"+e),s=$("#pageContainer"+e),t&&h&&h(e,1)})}}(t);case 3:break;case 21:e=new b(t);break;case 24:e=new x(t);break;case 25:e=new y(t);break;case 26:(e=new C(t)).SetOnEdit(this.OnEditNote),e.SetOnRecord(this.OnRecordNote);break;case 27:(e=new m(t)).SetOnEdit(this.OnEditBoard),e.SetOnRecord(this.OnRecordBoard);break;case 28:(e=new w(t)).SetOnEdit(this.OnEditText);break;case 32:(e=new W(t,Q.GetScale())).SetOnZoom(this.OnZoomChange);break;case 33:(e=new T(t)).SetOnEdit(this.OnEditVideo);break;case 34:e=new A(t);break;case 35:e=new S(t);break;case 101:e=new R(t);break;case 102:e=new _(t);break;case 103:e=new P(t);break;case 104:e=new E(t),1==t.stat?Tt(t.id):At(t.id);break;case 201:e=new I(t);break;case 202:e=new z(t)}e?(e.SetParamter(o,s,n,f,q),e.SetCanEdit(tt),e.Play()):console.log("Not support:"+JSON.stringify(t))},this.ShowDocument=function(t,e,i,r){var a,d,l=this;xt(),Wt(),n=t,f=i,O=e,Q.SetMain(t),Q.ShowPDF(e,i,function(t,e){v=e,o=$("#svg"+i),s=$("#pageContainer"+i),l.SetDrawTool(""),r&&r(t,e),t&&h&&h(i,2)}),a=null,d=function(t){a&&clearTimeout(a),a=setTimeout(function(){It()},200)},n.unbind("scroll",d).unbind("mousemove",Vt).unbind("mouseout",Nt).unbind("click",wt),n.bind("scroll",d).bind("mousemove",Vt).bind("mouseout",Nt).bind("click",wt)},this.RefreshDocument=function(t){var e=this;if(s&&n){var i=f;St(),xt();var r=this.GetPageInfo();Q.ShowPDF(O,i,function(t,n){o=$("#svg"+i),s=$("#pageContainer"+i),e.ResumeTool()},function(){var n=!0,o=!1,s=void 0;try{for(var a,d=r[Symbol.iterator]();!(n=(a=d.next()).done);n=!0){var l=a.value;e.Play(l)}}catch(t){o=!0,s=t}finally{try{!n&&d.return&&d.return()}finally{if(o)throw s}}t&&t(!0,i)})}else t&&t(!1,f)},this.GetPageInfo=function(t){var e=o,i=new Array;if(!t){if(!e)return i;t=e.find(">path,>rect,>circle")}return t.each(function(t){var e,r=$(this).attr("tp"),a=null;if("line"==r)a=Ct("ToolPen");else if("sline"==r)a=Ct("ToolLine");else if("brush"==r)a=Ct("ToolBrush");else if("text"==r)a=Ct("ToolText");else if("note"==r)a=Ct("ToolNote");else{if("board"!=r)return;a=Ct("ToolBoard")}if(a.SetEle($(this)[0]),a.SetParamter(null,o,s,n,f,null),e=a.Record(!1),i.push(e),"board"==r){var d=$(this).attr("id");$("#div_"+d).find(">svg").find(">path").each(function(t){if("line"==$(this).attr("tp")){var e=Ct("ToolPen");e.SetEle($(this)[0]),e.SetParamter(null,o,s,n,f,null);var r=e.Record(!1);r.tar="div_"+d,i.push(r)}})}}),s.find("div.live-video-tool-container").each(function(t){var e=Ct("ToolVideo");e.SetEle($(this)[0]),e.SetParamter(null,o,s,n,f,null);var r=e.Record(!1);i.push(r)}),i},this.NextPage=function(t){var e=this;if(f>=v)t&&t(!1,-1);else{s.hide();var i=f+1;if(xt(),St(),Wt(),$("#pageContainer"+i).length>0){Q.SetPageNumber(i),f=i,o=$("#svg"+i),(s=$("#pageContainer"+i)).show();var n=!1;if(0==at?Math.abs(Et()-Rt())>100&&(n=!0):1==at&&Math.abs(Pt()-_t())>100&&(n=!0),n){var r=this.GetPageInfo();this.Clear(),Q.SizeChanged(1);var a=!0,d=!1,l=void 0;try{for(var c,u=r[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var p=c.value;this.Play(p)}}catch(t){d=!0,l=t}finally{try{!a&&u.return&&u.return()}finally{if(d)throw l}}}this.ResumeTool(),zt(i),t&&t(!0,i),h&&h(i,3)}else Q.ShowImagePageEx(i,function(n){f=i,o=$("#svg"+i),s=$("#pageContainer"+i),e.ResumeTool(),n&&zt(i),t&&t(n,i),n&&h&&h(i,3)},!1,Q.GetPdfPageUrl(Q.AdjustURL(O),i),!1)}},this.PreviewPage=function(t){var e=this;if(f<=1)t&&t(!1,-1);else{s.hide(),xt(),St(),Wt();var i=f-1;if($("#pageContainer"+i).length>0){Q.SetPageNumber(i),f=i,o=$("#svg"+i),(s=$("#pageContainer"+i)).show();var n=!1;if(0==at?Math.abs(Et()-Rt())>100&&(n=!0):1==at&&Math.abs(Pt()-_t())>100&&(n=!0),n){var r=this.GetPageInfo();this.Clear(),Q.SizeChanged(1);var a=!0,d=!1,l=void 0;try{for(var c,u=r[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var p=c.value;this.Play(p)}}catch(t){d=!0,l=t}finally{try{!a&&u.return&&u.return()}finally{if(d)throw l}}}this.ResumeTool(),zt(i),t&&t(!0,i),h&&h(i,4)}else Q.ShowImagePageEx(i,function(n){f=i,o=$("#svg"+i),s=$("#pageContainer"+i),e.ResumeTool(),n&&zt(i),t&&t(n,i),n&&h&&h(i,4)},!1,Q.GetPdfPageUrl(Q.AdjustURL(O),i),!1)}},this.ToPage=function(t,e){var i=this;t>v||t<1?e&&e(!1,-1):(s.hide(),xt(),St(),Wt(),$("#pageContainer"+t).length>0?(Q.SetPageNumber(t),f=t,o=$("#svg"+t),(s=$("#pageContainer"+t)).show(),this.ResumeTool(),zt(t),e&&e(!0,t),h&&h(t,5)):Q.ShowImagePageEx(t,function(n,r){f=t,o=$("#svg"+t),s=$("#pageContainer"+t),i.ResumeTool(),n&&zt(t),e&&e(n,t),n&&h&&h(t,5)},!1,Q.GetPdfPageUrl(Q.AdjustURL(O),t),!1))},this.PreLoadPage=function(t,e){!n||t>v||t<1||$("#pageContainer"+t).length>0?e&&e(!1,-1):Q.ShowImagePageEx(t,function(i,n){e&&e(i,t)},!0,Q.GetPdfPageUrl(Q.AdjustURL(O),t),!1)},this.ZoomIn=function(t){var e=Q.ZoomIn();t&&t(e),It()},this.ZoomOut=function(t){var e=Q.ZoomOut();t&&t(e),It()},this.ZoomTo=function(t,e){Q.SizeChanged(t),e&&e(t),It()},this.Undo=function(t){if(0!=lt.length){var e=lt.pop();if(Array.isArray(e.Undo))for(var i=0,n=e.Undo.length;i<n;i++)$t(e.Undo[i]),this.Play(e.Undo[i]);else $t(e.Undo),this.Play(e.Undo);ht.push(e),g&&(0==lt.length?g(0,1):1==ht.length&&g(lt.length>0?1:0,1))}else t&&t(!1)},this.Redo=function(t){if(0!=ht.length){var e=ht.pop();if(Array.isArray(e.Redo))for(var i=0,n=e.Redo.length;i<n;i++)$t(e.Redo[i]),this.Play(e.Redo[i]);else $t(e.Redo),this.Play(e.Redo);lt.push(e),g&&(0==ht.length?g(1,0):1==lt.length&&g(1,ht.length>0?1:0))}else t&&t(!1)},this.OnPageChange=function(t){h=t},this.OnSelectVideo=function(t){c=t},this.OnBoardDisplayChange=function(t){u=t},this.OnVideoPlay=function(t){p=t},this.OnUndoRedoStatChange=function(t){g=t},this.SetCanEdit=function(t){tt=t,Z&&Z.SetCanEdit(t),t||xt()},this.TriggerPageChange=function(){zt(f)},this.TriggerViewChange=function(){It()}}}]);